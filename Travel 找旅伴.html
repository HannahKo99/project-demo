<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TripMate - æ—…éŠç¤¾ç¾¤å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icon Library for modern, clean icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      /* Custom scrollbar for better aesthetics and less visual clutter */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background-color: transparent;
      }

      /* å´é‚Šæ¬„æ¨£å¼ */
      .aside-nav {
        border: 2px solid #1f2937; /* gray-800 */
      }
      .nav-item:hover {
        background-color: #f3f4f6;
        transform: translateX(4px);
      }
      .nav-item.active {
        background-color: #e0f2fe;
        border-right: 4px solid #0ea5e9;
      }
      .nav-item {
        transition: all 0.2s;
      }

      /* Drag and Drop Styling */
      .activity-item:hover .activity-content {
        /* Subtle hover state for draggable items */
        background-color: #f0f9ff; /* blue-50 */
      }
      .activity-item.opacity-30 {
        opacity: 0.3; /* Visual cue when dragging */
      }
      .activity-item.drag-target .activity-content {
        border: 2px dashed #6366f1; /* indigo-500 dashed border for drop target */
        padding-top: 10px;
        padding-bottom: 10px;
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans custom-scrollbar">
    <!-- Header (Fixed Top Navigation) -->
    <header
      class="fixed top-0 left-0 right-0 bg-white shadow-md z-50 h-16 flex items-center px-4"
    >
      <div
        onclick="navigate('home')"
        class="cursor-pointer flex items-center space-x-2 mr-8"
      >
        <!-- Logoï¼šä½¿ç”¨ç´™é£›æ©Ÿåœ–ç¤º (navigation-2) ä»£è¡¨æ—…è¡Œ -->
        <i
          data-lucide="navigation-2"
          class="w-8 h-8 text-indigo-600 fill-indigo-600 transform rotate-45"
        ></i>
        <span class="text-2xl font-black text-gray-800 tracking-tight"
          >TripMate</span
        >
      </div>
      <!-- Search Bar (Desktop) -->
      <div class="hidden lg:flex flex-1 max-w-xl relative">
        <input
          type="text"
          placeholder="æœå°‹æ–‡ç« ã€è¡Œç¨‹..."
          class="w-full py-2 pl-4 pr-10 border-2 border-gray-200 rounded-full focus:border-indigo-500 focus:outline-none transition"
        />
        <i
          data-lucide="search"
          class="absolute right-3 top-2.5 w-5 h-5 text-gray-400"
        ></i>
      </div>
      <!-- User Actions (Notifications, Cart, Profile, Mobile Menu) -->
      <div class="flex items-center space-x-3 ml-auto">
        <button class="p-2 hover:bg-gray-100 rounded-full">
          <i data-lucide="bell" class="w-6 h-6 text-gray-600"></i>
        </button>
        <button
          onclick="navigate('cart')"
          class="p-2 hover:bg-gray-100 rounded-full"
        >
          <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600"></i>
        </button>
        <button
          onclick="navigate('profile')"
          class="p-2 hover:bg-gray-100 rounded-full"
        >
          <i data-lucide="user" class="w-6 h-6 text-gray-600"></i>
        </button>
        <button class="p-2 hover:bg-gray-100 rounded-full lg:hidden">
          <i data-lucide="menu" class="w-6 h-6 text-gray-600"></i>
        </button>
      </div>
    </header>

    <!-- Main Layout Container -->
    <div class="flex pt-20 px-4 max-w-[1600px] mx-auto min-h-screen">
      <!-- Aside Nav (Left Sidebar - Desktop Only) -->
      <aside
        class="fixed left-4 top-20 w-64 bg-white rounded-[2rem] shadow-xl p-4 hidden lg:flex flex-col z-40 h-[calc(100vh-6rem)] custom-scrollbar overflow-y-auto aside-nav"
      >
        <!-- Top Actions: Favorites and Collections -->
        <div class="flex justify-between mb-4 pb-4 border-b-2 border-gray-100">
          <div
            onclick="navigate('favorites')"
            class="cursor-pointer w-[48%] aspect-square rounded-2xl border-2 border-gray-800 flex flex-col items-center justify-center hover:bg-red-50 transition group"
          >
            <i
              data-lucide="heart"
              class="w-8 h-8 text-gray-400 group-hover:text-red-500 transition fill-transparent group-hover:fill-red-500"
            ></i>
            <span class="text-xs font-bold mt-1 text-gray-600">æ„›å¿ƒ</span>
          </div>
          <div
            onclick="navigate('collections')"
            class="cursor-pointer w-[48%] aspect-square rounded-2xl border-2 border-gray-800 flex flex-col items-center justify-center hover:bg-yellow-50 transition group"
          >
            <i
              data-lucide="bookmark"
              class="w-8 h-8 text-gray-400 group-hover:text-yellow-500 transition fill-transparent group-hover:fill-yellow-500"
            ></i>
            <span class="text-xs font-bold mt-1 text-gray-600">æ”¶è—</span>
          </div>
        </div>

        <!-- Nav List -->
        <nav class="space-y-1">
          <a
            onclick="navigate('home')"
            id="nav-home"
            class="nav-item flex items-center p-3 rounded-xl cursor-pointer"
          >
            <i
              data-lucide="pin"
              class="w-5 h-5 text-red-500 mr-3 fill-red-500 transform rotate-45"
            ></i>
            <span class="font-bold text-gray-700">ç‚ºä½ æ¨è–¦</span>
          </a>
          <a
            onclick="navigate('discussion')"
            id="nav-discussion"
            class="nav-item flex items-center p-3 rounded-xl cursor-pointer"
          >
            <i
              data-lucide="pin"
              class="w-5 h-5 text-red-500 mr-3 fill-red-500 transform rotate-45"
            ></i>
            <span class="font-bold text-gray-700">è¨è«–å€</span>
          </a>
          <a
            onclick="navigate('find_traveler')"
            id="nav-find_traveler"
            class="nav-item flex items-center p-3 rounded-xl cursor-pointer"
          >
            <i
              data-lucide="pin"
              class="w-5 h-5 text-red-500 mr-3 fill-red-500 transform rotate-45"
            ></i>
            <span class="font-bold text-gray-700">æ‰¾æ—…ä¼´</span>
          </a>
          <a
            onclick="navigate('featured_itinerary')"
            id="nav-featured_itinerary"
            class="nav-item flex items-center p-3 rounded-xl cursor-pointer"
          >
            <i
              data-lucide="pin"
              class="w-5 h-5 text-red-500 mr-3 fill-red-500 transform rotate-45"
            ></i>
            <span class="font-bold text-gray-700">ç²¾é¸è¡Œç¨‹</span>
          </a>
          <div class="my-2 border-t-2 border-dashed border-gray-200"></div>
          <a
            onclick="navigate('my_itinerary')"
            id="nav-my_itinerary"
            class="nav-item flex items-center p-3 rounded-xl cursor-pointer"
          >
            <i
              data-lucide="pin"
              class="w-5 h-5 text-red-500 mr-3 fill-red-500 transform rotate-45"
            ></i>
            <span class="font-bold text-gray-700">æˆ‘çš„è¡Œç¨‹</span>
          </a>
          <!-- Future Feature Placeholders -->
          <a
            onclick="openModal('future_feature')"
            class="nav-item flex items-center p-3 rounded-xl cursor-pointer hover:opacity-70"
          >
            <i
              data-lucide="pin"
              class="w-5 h-5 text-gray-400 mr-3 transform rotate-45"
            ></i>
            <span class="font-bold text-gray-400">è¨±é¡˜æ± </span>
          </a>
          <a
            onclick="toggleChatWindow()"
            class="nav-item flex items-center p-3 rounded-xl cursor-pointer hover:opacity-70"
          >
            <i
              data-lucide="pin"
              class="w-5 h-5 text-gray-400 mr-3 transform rotate-45"
            ></i>
            <span class="font-bold text-gray-900">éœ€è¦æŒ‡å¼•</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content Area -->
      <main id="main-content" class="lg:ml-72 w-full pb-20">
        <!-- Content will be rendered here by JavaScript -->
      </main>
    </div>

    <!-- Floating Action Buttons (FABs) -->
    <div class="fixed bottom-8 right-8 flex flex-col space-y-3 z-50">
      <!-- Post/Create Button -->
      <button
        onclick="openModal('posting_choice')"
        class="p-4 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition hover:scale-110"
      >
        <i data-lucide="plus" class="w-6 h-6"></i>
      </button>
      <!-- Quick Action (e.g., Quick Plan) -->
      <button
        class="p-4 bg-amber-500 text-white rounded-full shadow-lg hover:bg-amber-600 transition hover:scale-110"
      >
        <i data-lucide="zap" class="w-6 h-6"></i>
      </button>
      <!-- Chat/Message Button -->
      <button
        onclick="togglePrivateChatWindow()"
        class="p-4 bg-green-500 text-white rounded-full shadow-lg hover:bg-green-600 transition hover:scale-110"
      >
        <i data-lucide="message-square" class="w-6 h-6"></i>
      </button>
      <!-- AI Assistant Button -->
      <button
        onclick="toggleChatWindow()"
        class="p-4 bg-orange-500 text-white rounded-full shadow-lg hover:bg-orange-600 transition hover:scale-110"
      >
        <i data-lucide="bot" class="w-6 h-6"></i>
      </button>
    </div>

    <!-- Modal Container -->
    <div
      id="modal-container"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4"
    ></div>

    <!-- Chat Window (Fixed Bottom Right) -->
    <div
      id="chat-window"
      class="fixed bottom-24 right-8 w-96 h-[600px] bg-white rounded-2xl shadow-2xl z-50 hidden flex flex-col border-4 border-gray-800"
    >
      <!-- Chat Header -->
      <div
        class="bg-orange-500 text-white p-4 rounded-t-xl flex items-center justify-between"
      >
        <div class="flex items-center space-x-3">
          <i data-lucide="bot" class="w-6 h-6"></i>
          <div>
            <h3 class="font-bold text-lg">TripMate åŠ©æ‰‹</h3>
            <p class="text-xs text-orange-100">éš¨æ™‚ç‚ºæ‚¨æä¾›æ—…éŠæŒ‡å¼•</p>
          </div>
        </div>
        <button
          onclick="toggleChatWindow()"
          class="p-2 hover:bg-orange-600 rounded-full transition"
        >
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Chat Messages Area -->
      <div
        id="chat-messages"
        class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-gray-50"
      >
        <!-- Welcome Message -->
        <div class="flex items-start space-x-2">
          <div
            class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center flex-shrink-0"
          >
            <i data-lucide="bot" class="w-5 h-5 text-white"></i>
          </div>
          <div
            class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm max-w-[80%]"
          >
            <p class="text-sm text-gray-800">
              æ‚¨å¥½ï¼æˆ‘æ˜¯ TripMate åŠ©æ‰‹ï¼Œå¾ˆé«˜èˆˆç‚ºæ‚¨æœå‹™ï¼
            </p>
            <p class="text-sm text-gray-800 mt-2">æˆ‘å¯ä»¥å”åŠ©æ‚¨ï¼š</p>
            <ul
              class="text-sm text-gray-700 mt-2 space-y-1 list-disc list-inside"
            >
              <li>è¦åŠƒæ—…éŠè¡Œç¨‹</li>
              <li>æ¨è–¦æ™¯é»èˆ‡ç¾é£Ÿ</li>
              <li>è§£ç­”æ—…éŠç›¸é—œå•é¡Œ</li>
              <li>æä¾›å¯¦ç”¨æ—…éŠå»ºè­°</li>
            </ul>
            <p class="text-sm text-gray-800 mt-2">è«‹å‘Šè¨´æˆ‘æ‚¨éœ€è¦ä»€éº¼å”åŠ©ï¼Ÿ</p>
          </div>
        </div>
      </div>

      <!-- Chat Input Area -->
      <div class="p-4 border-t border-gray-200 bg-white rounded-b-xl">
        <form
          id="chat-form"
          onsubmit="event.preventDefault(); sendChatMessage();"
          class="flex items-center space-x-2"
        >
          <input
            type="text"
            id="chat-input"
            placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."
            class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-full focus:border-orange-500 focus:outline-none text-sm"
            autocomplete="off"
          />
          <button
            type="submit"
            class="p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition"
          >
            <i data-lucide="send" class="w-5 h-5"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Private Chat Window (Fixed Bottom Right) -->
    <div
      id="private-chat-window"
      class="fixed bottom-24 right-8 w-96 h-[600px] bg-white rounded-2xl shadow-2xl z-50 hidden flex flex-col border-4 border-gray-800"
    >
      <!-- Chat Header -->
      <div
        class="bg-green-500 text-white p-4 rounded-t-xl flex items-center justify-between"
      >
        <div class="flex items-center space-x-3">
          <i data-lucide="message-square" class="w-6 h-6"></i>
          <div>
            <h3 class="font-bold text-lg">ç§äººèŠå¤©</h3>
            <p class="text-xs text-green-100">èˆ‡å¥½å‹èŠå¤©</p>
          </div>
        </div>
        <button
          onclick="togglePrivateChatWindow()"
          class="p-2 hover:bg-green-600 rounded-full transition"
        >
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Chat Messages Area -->
      <div
        id="private-chat-messages"
        class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-gray-50"
      >
        <!-- Welcome Message -->
        <div class="flex items-start space-x-2">
          <div
            class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0"
          >
            <i data-lucide="message-square" class="w-5 h-5 text-white"></i>
          </div>
          <div
            class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm max-w-[80%]"
          >
            <p class="text-sm text-gray-800">æ­¡è¿ä¾†åˆ°ç§äººèŠå¤©å®¤ï¼</p>
            <p class="text-sm text-gray-800 mt-2">
              æ‚¨å¯ä»¥åœ¨é€™è£¡èˆ‡å…¶ä»–ç”¨æˆ¶é€²è¡Œç§äººå°è©±ã€‚
            </p>
          </div>
        </div>
      </div>

      <!-- Chat Input Area -->
      <div class="p-4 border-t border-gray-200 bg-white rounded-b-xl">
        <form
          id="private-chat-form"
          onsubmit="event.preventDefault(); sendPrivateChatMessage();"
          class="flex items-center space-x-2"
        >
          <input
            type="text"
            id="private-chat-input"
            placeholder="è¼¸å…¥è¨Šæ¯..."
            class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-full focus:border-green-500 focus:outline-none text-sm"
            autocomplete="off"
          />
          <button
            type="submit"
            class="p-2 bg-green-500 text-white rounded-full hover:bg-green-600 transition"
          >
            <i data-lucide="send" class="w-5 h-5"></i>
          </button>
        </form>
      </div>
    </div>

    <script>
      // App State & Mock Data
      const appState = {
        currentPage: "home",
        mockPosts: [
          {
            id: 1,
            type: "find_traveler",
            title: "åŒ—æµ·é“è³é›ªä¹‹æ—…å¾µåŒè¡Œå¤¥ä¼´",
            content:
              "ç¬¬ä¸€æ¬¡å»åŒ—æµ·é“ï¼Œæƒ³æ‰¾äººä¸€èµ·åˆ†æ”¤ä½å®¿è²»ï¼Œç›®å‰é–å®šåœ¨æœ­å¹Œã€å°æ¨½ä¸€å¸¶ã€‚å¸Œæœ›æ‰¾åˆ°å€‹æ€§é–‹æœ—ã€èƒ½ä¸€èµ·è¦åŠƒè¡Œç¨‹çš„æ—…ä¼´ï¼Œè¡Œç¨‹é è¨ˆ5å¤©ã€‚",
            author: "Jovi",
            avatar: "https://placehold.co/100x100/A0BFFF/ffffff?text=J",
            image:
              "https://placehold.co/800x400/5E8FF9/ffffff?text=Hokkaido+Snow+Scenery",
            time: "5å°æ™‚å‰",
            comments: 6,
            hearts: 12,
            tags: ["æ—¥æœ¬", "åŒ—æµ·é“", "é›ªæ™¯"],
            participants: 2,
            required: 4,
            location: "æœ­å¹Œ",
            date: "2025/12/15",
            spiritAnimal: "ğŸ¦ æ¨‚å¤©æ´¾",
          },
          {
            id: 2,
            type: "find_traveler",
            title: "æ­æ´²è‡ªåŠ©40å¤©è¡Œç¨‹è«‹ç›Š",
            content:
              "ç¬¬ä¸€æ¬¡å»æ­æ´²æƒ³èµ°ç¾©æ³•ç‘å¥§ï¼Œå·²ç¶“å®‰æ’å¥½å¤§è‡´è·¯ç·šï¼Œæ±‚ç¥äººå¹«å¿™æª¢æŸ¥æˆ–æ¨è–¦ç§æˆ¿æ™¯é»ï¼",
            author: "å°é›¨",
            avatar: "https://placehold.co/100x100/F9D05F/ffffff?text=R",
            image:
              "https://placehold.co/800x400/F9A05F/ffffff?text=Europe+Trip",
            time: "1å¤©å‰",
            comments: 15,
            hearts: 30,
            tags: ["æ­æ´²", "è‡ªåŠ©æ—…è¡Œ"],
            participants: 1,
            required: 1,
            location: "å·´é»",
            date: "2026/06/01",
            spiritAnimal: "ğŸ¦‰ è§€å¯Ÿå®¶",
          },
          {
            id: 3,
            type: "find_traveler",
            title: "å°ç£ç’°å³¶å°‹æ‰¾æ”å½±å¸«æ—…ä¼´",
            content:
              "æƒ³æ‰¾ä¸€ä½å–œæ­¡æ”å½±çš„æ—…ä¼´ä¸€èµ·é¨è»Šç’°å³¶ï¼Œå¾æ±éƒ¨é–‹å§‹å‡ºç™¼ï¼Œæ‹ä¸‹ç¾éº—çš„å°ç£é¢¨æ™¯ã€‚",
            author: "é˜¿å…‰",
            avatar: "https://placehold.co/100x100/A8FFC0/333333?text=K",
            image:
              "https://placehold.co/800x400/7CFFD4/333333?text=Taiwan+Round+Island",
            time: "2å¤©å‰",
            comments: 3,
            hearts: 8,
            tags: ["å°ç£", "æ”å½±"],
            participants: 1,
            required: 2,
            location: "å°æ±",
            date: "2025/10/01",
            spiritAnimal: "ğŸ¦… å†’éšªç‹",
          },
          {
            id: 4,
            type: "discussion",
            title: "#åœ‹å¤–éŠè¨˜ #æ—¥æœ¬éŠè¨˜ ç€¨æˆ¶å…§æµ·ä¹‹æ—… PART1",
            content:
              "ç¬¬ä¸€æ¬¡ç™¼æ–‡åˆ†äº«æ—…éŠå¿ƒå¾—ï¼Œæœ‰é»ç·Šå¼µ...\n\né€™æ¬¡å»äº†ç€¨æˆ¶å…§æµ·ï¼ŒçœŸçš„æ˜¯å€‹å¾ˆç¾çš„åœ°æ–¹ï¼ç¬¬ä¸€æ¬¡è¦åŠƒé€™éº¼é•·çš„è¡Œç¨‹ï¼Œå¾ˆæ“”å¿ƒæœƒå‡ºä»€éº¼å·®éŒ¯ï¼Œä½†æœ€å¾Œé‚„æ˜¯é †åˆ©å®Œæˆäº†ã€‚\n\næƒ³å•å•å¤§å®¶ï¼Œæœ€è¿‘æƒ³å˜—è©¦ç¨è‡ªæ—…è¡Œï¼Œè«‹å•å¤§å®¶æœ‰æ¨è–¦å“ªå€‹åœ‹å®¶æ¯”è¼ƒå®‰å…¨ã€å°å–®èº«å¥³æ€§å‹å–„çš„å—ï¼Ÿ",
            author: "å²åŠªæ¯”",
            avatar: "https://placehold.co/100x100/FFB6C1/ffffff?text=S",
            image:
              "https://placehold.co/800x400/5F5FF9/ffffff?text=Seto+Inland+Sea+Trip",
            time: "æ˜¨å¤© 16:50",
            comments: 3,
            hearts: 12,
            tags: ["åœ‹å¤–éŠè¨˜", "æ—¥æœ¬éŠè¨˜"],
            spiritAnimal: "ğŸº ç¨è¡Œè€…",
            isAuthor: true,
          },
          {
            id: 5,
            type: "find_traveler",
            title: "12æœˆåŒ—æµ·é“è³é›ªä¹‹æ—…",
            content:
              "æ‰¾äººä¸€èµ·åˆ†æ”¤ä½å®¿è²»ï¼Œä½›ç³»æ—…éŠï¼Œä¸»è¦è¡Œç¨‹é‚„æœªå®šï¼Œæœ‰èˆˆè¶£çš„å¯ä»¥ç§è¨Šè¨è«–ã€‚",
            author: "é›ªäºº",
            avatar: "https://placehold.co/100x100/D0FFFF/333333?text=SN",
            image:
              "https://placehold.co/800x400/AAAAAA/ffffff?text=Hokkaido+Winter",
            time: "1h",
            comments: 5,
            hearts: 5,
            tags: ["ä½›ç³»", "åŒ—æµ·é“"],
            participants: 0,
            required: 1,
            location: "åŒ—æµ·é“",
            date: "12/01",
            spiritAnimal: "ğŸ§ æ…¢æ´»è€…",
          },
          {
            id: 6,
            type: "find_traveler",
            title: "äº¬éƒ½è³æ¥“æ”å½±åœ˜",
            content:
              "æƒ³åœ¨äº¬éƒ½æ‰¾ä¸€å€‹å–œæ­¡æ”å½±çš„æœ‹å‹äº’ç›¸å¹«å¿™æ‹ç¾ç…§ï¼Œé¢¨æ™¯ç…§ç‚ºä¸»ï¼Œç¼ºæ¨¡ç‰¹å…’äº’æ‹ï¼Œæ™‚é–“å½ˆæ€§ã€‚",
            author: "é˜¿æ°",
            avatar: "https://placehold.co/100x100/FFC0A8/333333?text=AJ",
            image:
              "https://placehold.co/800x400/F08080/ffffff?text=Kyoto+Autumn+Leaves",
            time: "3h",
            comments: 4,
            hearts: 10,
            tags: ["æ”å½±", "äº¬éƒ½"],
            participants: 1,
            required: 2,
            location: "äº¬éƒ½",
            date: "11/15",
            spiritAnimal: "ğŸ¦Š è—è¡“å®¶",
          },
          {
            id: 7,
            type: "find_traveler",
            title: "æ›¼è°·ç¾é£Ÿçˆ†é£Ÿåœ˜",
            content:
              "ç›®æ¨™åƒéæ›¼è°·å¤œå¸‚ã€ç±³å…¶æ—å°åƒï¼æ­¡è¿å°åƒæœ‰ç†±æƒ…çš„å¤¥ä¼´åŠ å…¥ï¼Œä¸è¨ˆè¼ƒå½¢è±¡ã€‚",
            author: "åƒè²¨",
            avatar: "https://placehold.co/100x100/FFC0FF/333333?text=EAT",
            image:
              "https://placehold.co/800x400/F9D05F/333333?text=Bangkok+Food+Tour",
            time: "6h",
            comments: 8,
            hearts: 20,
            tags: ["ç¾é£Ÿ", "æ³°åœ‹"],
            participants: 2,
            required: 4,
            location: "æ›¼è°·",
            date: "10/10",
            spiritAnimal: "ğŸ¼ ç¾é£Ÿå®¶",
          },
          {
            id: 8,
            type: "featured_itinerary",
            title: "ç¾©å¤§åˆ©æ·±åº¦10æ—¥éŠï¼šç¾…é¦¬ã€ä½›ç¾…å€«æ–¯",
            content:
              "é€™æ˜¯ä¸€å€‹ç¶“éé©—è­‰çš„é«˜è©•åˆ†è¡Œç¨‹ï¼Œæ¶µè“‹ç¾…é¦¬ç«¶æŠ€å ´ã€æ¢µè’‚å²¡ã€ä»¥åŠä½›ç¾…å€«æ–¯æ–‡è—å¾©èˆˆè—è¡“ä¹‹æ—…ã€‚æ¯æ—¥è©³ç´°è¡Œç¨‹èˆ‡é ç®—åˆ†æå·²å…§é™„ã€‚",
            author: "TripMate ç²¾é¸",
            avatar: "https://placehold.co/100x100/5C6BC0/ffffff?text=TM",
            image: "https://placehold.co/800x400/9C27B0/ffffff?text=Italy+Tour",
            time: "2é€±å‰",
            comments: 50,
            hearts: 150,
            tags: ["æ­æ´²", "æ–‡åŒ–", "10å¤©"],
            rating: 4.8,
            spiritAnimal: "ğŸ¤– ç³»çµ±æ¨è–¦",
          },
          {
            id: 9,
            type: "featured_itinerary",
            title: "æ±äº¬è³¼ç‰©ç¾é£Ÿäº”å¤©å››å¤œ",
            content:
              "å¾æ¾€è°·ã€æ–°å®¿åˆ°éŠ€åº§çš„è³¼ç‰©å¤©å ‚ï¼Œå†åˆ°ç¯‰åœ°å¸‚å ´å’Œç±³å…¶æ—ç¾é£Ÿæ¢éšªã€‚é€™å€‹è¡Œç¨‹æ˜¯ç‚ºè³¼ç‰©ç‹‚å’Œç¾é£Ÿå®¶é‡èº«å®šåšã€‚",
            author: "æ—…éŠé”äºº Mandy",
            avatar: "https://placehold.co/100x100/FF5722/ffffff?text=M",
            image: "https://placehold.co/800x400/FF5722/ffffff?text=Tokyo+Food",
            time: "1å€‹æœˆå‰",
            comments: 80,
            hearts: 210,
            tags: ["äºæ´²", "ç¾é£Ÿ", "è³¼ç‰©", "5å¤©"],
            rating: 4.5,
            spiritAnimal: "ğŸ¦‹ è¿½å¤¢äºº",
          },
          {
            id: 10,
            type: "featured_itinerary",
            title: "å†°å³¶ç’°å³¶è‡ªé§•ä¸ƒæ—¥ï¼šè¿½å°‹æ¥µå…‰èˆ‡å†°æ²³æ¹–",
            content:
              "æœ€å—æ­¡è¿çš„å†°å³¶è‡ªé§•è·¯ç·šï¼Œæ¶µè“‹é»ƒé‡‘åœˆã€å—éƒ¨æµ·å²¸ã€å†°æ²³æ¹–ç­‰ç¶“å…¸æ™¯é»ï¼Œä¸¦æä¾›æœ€ä½³æ¥µå…‰è§€æ¸¬é»å»ºè­°ã€‚",
            author: "æ¥µå…‰æ¢éšªå®¶",
            avatar: "https://placehold.co/100x100/2196F3/ffffff?text=E",
            image:
              "https://placehold.co/800x400/2196F3/ffffff?text=Iceland+Road+Trip",
            time: "3å€‹æœˆå‰",
            comments: 120,
            hearts: 350,
            tags: ["æˆ¶å¤–", "è‡ªé§•", "æ¥µå…‰", "7å¤©"],
            rating: 4.9,
            spiritAnimal: "ğŸ§­ æ¢éšªå®¶",
          },
        ],
        // Mock data for "My Itinerary" page
        mockItineraries: [
          {
            id: "i1",
            title: "å°åŒ—ç¾é£Ÿäº”æ—¥éŠ",
            startDate: "2024.12.20",
            endDate: "2024.12.24",
            status: "upcoming",
            days: [
              {
                date: "Day 1 (12/20)",
                activities: [
                  {
                    time: "09:00",
                    icon: "camera",
                    name: "å°åŒ— 101",
                    description: "åƒè§€å°åŒ— 101ï¼Œé«”é©—åŸå¸‚æ–‡åŒ–",
                  },
                  {
                    time: "12:00",
                    icon: "coffee",
                    name: "é¼æ³°è±åˆé¤",
                    description: "åœ¨é¼æ³°è±äº«ç”¨åˆé¤",
                  },
                  {
                    time: "15:00",
                    icon: "map-pin",
                    name: "è±¡å±±æ­¥é“",
                    description: "ç™»ä¸Šè±¡å±±é£½è¦½å°åŒ—å…¨æ™¯",
                  },
                ],
              },
              {
                date: "Day 2 (12/21)",
                activities: [
                  {
                    time: "10:00",
                    icon: "train",
                    name: "è¥¿é–€ç”º",
                    description: "æ­ä¹˜æ·é‹å‰å¾€è¥¿é–€ç”º",
                  },
                  {
                    time: "11:30",
                    icon: "shopping-bag",
                    name: "è¥¿é–€ç”ºè³¼ç‰©",
                    description: "åœ¨è¥¿é–€ç”ºå•†åœˆé€›è¡—",
                  },
                  {
                    time: "18:00",
                    icon: "utensils",
                    name: "å¯§å¤å¤œå¸‚æ™šé¤",
                    description: "é«”é©—å¯§å¤å¤œå¸‚ç¾é£Ÿæ–‡åŒ–",
                  },
                ],
              },
              {
                date: "Day 3 (12/22)",
                activities: [
                  {
                    time: "10:00",
                    icon: "mountain",
                    name: "ä¹ä»½ä¸€æ—¥éŠ",
                    description: "åƒåŠ ä¹ä»½/å¹³æºªå‘¨é‚Šæ™¯é»ä¸€æ—¥éŠ",
                  },
                  {
                    time: "20:00",
                    icon: "bed",
                    name: "å›é£¯åº—ä¼‘æ¯",
                    description: "æº–å‚™éš”æ—¥è¡Œç¨‹",
                  },
                ],
              },
            ],
            packingList: [
              {
                category: "è­‰ä»¶",
                items: [
                  { name: "è­·ç…§", checked: true },
                  { name: "æ©Ÿç¥¨", checked: true },
                ],
              },
              {
                category: "è¡£ç‰©",
                items: [
                  { name: "æ›æ´—è¡£ç‰©", checked: false },
                  { name: "ä¿æš–å¤–å¥—", checked: true },
                ],
              },
              {
                category: "é›»å­ç”¢å“",
                items: [
                  { name: "ç›¸æ©Ÿ", checked: false },
                  { name: "å……é›»å™¨", checked: true },
                ],
              },
              {
                category: "å€‹äººç”¨å“",
                items: [
                  { name: "è—¥å“", checked: false },
                  { name: "é˜²æ›¬ä¹³", checked: false },
                ],
              },
            ],
          },
          {
            id: "i2",
            title: "äº¬éƒ½è³æ¥“ä¹‹æ—…",
            startDate: "2025.01.15",
            endDate: "2025.01.18",
            status: "past",
          },
          // i3 æ²’æœ‰ packingList æ•¸æ“šï¼Œé€™æ­£æ˜¯å¯èƒ½å°è‡´éŒ¯èª¤çš„åŸå› 
          {
            id: "i3",
            title: "ç´ç´„è·¨å¹´ä¸ƒæ—¥",
            startDate: "2025.12.28",
            endDate: "2026.01.03",
            status: "planning",
          },
        ],
        mockDrafts: [
          {
            type: "discussion",
            title: "è©¢å•æ—¥æœ¬è¶…å•†å•é¡Œ",
            savedAt: "2024-12-05 14:30",
            contentPreview: "ä¸‹å€‹æœˆè¦å»æ—¥æœ¬æ±äº¬è‡ªç”±è¡Œï¼Œæƒ³åœ¨é‚£é‚Šè²·å¤§ç ”ç‰¹æ‹¿...",
          },
          {
            type: "find_traveler",
            title: "å¾µæ±‚æ˜¥å¤©åŒ—æµ·é“æ—…ä¼´",
            savedAt: "2024-12-04 10:15",
            contentPreview: "è¨ˆç•«æ˜å¹´4æœˆå»åŒ—æµ·é“è³æ«»ï¼Œæƒ³æ‰¾å¿—åŒé“åˆçš„æ—…ä¼´...",
          },
        ],
        currentUser: {
          name: "æ£®æ—é¹¿",
          avatar: "https://placehold.co/100x100/90EE90/333333?text=User",
        },
        // Favorites list (stored post IDs)
        favorites: [],
        // Liked posts list (stored post IDs) - separate from favorites
        likedPosts: [],
        // Editing itinerary state
        editingItinerary: null,
        currentEditDayIndex: 0,
        // Mock comments data for posts
        mockComments: {
          4: [
            {
              id: "c1",
              author: "å²åŠªæ¯”",
              avatar: "https://placehold.co/100x100/FFB6C1/ffffff?text=S",
              time: "3å°æ™‚å‰",
              content: "å¥½çš„,è¬è¬æŒ‡æ•™~å¯ä»¥çœ‹æ¸…æ¥šæ–‡ç« å†ä¾†ç‚®!",
              likes: 5,
              isAuthor: true,
              replies: [
                {
                  id: "r1",
                  author: "yuan",
                  avatar: "https://placehold.co/100x100/FFD700/333333?text=Y",
                  time: "2å°æ™‚å‰",
                  content: "å›è¦†å²åŠªæ¯”ï¼šå®Œå…¨åŒæ„ä½ çš„è§€é»ï¼",
                  likes: 2,
                  spiritAnimal: "é»ƒé‡‘çµçŠ¬",
                },
              ],
            },
            {
              id: "c2",
              author: "ihs;oaihoj",
              avatar: "https://placehold.co/100x100/87CEEB/333333?text=I",
              time: "5å°æ™‚å‰",
              content: "æ—¥æœ¬çœŸçš„å¾ˆé©åˆå–®ç¨æ—…è¡Œï¼Œæ²»å®‰å¾ˆå¥½ï¼",
              likes: 8,
              replies: [],
            },
            {
              id: "c3",
              author: "kawanana",
              avatar: "https://placehold.co/100x100/98FB98/333333?text=K",
              time: "1å¤©å‰",
              content: "æ¨è–¦å†°å³¶å’Œç´è¥¿è˜­ï¼Œéƒ½å¾ˆå®‰å…¨ä¸”é¢¨æ™¯å„ªç¾ï¼",
              likes: 12,
              replies: [],
            },
          ],
        },
        currentPostId: null, // Track which post detail is being viewed
        commentSort: "hot", // "hot", "newest", "oldest"
      };

      // Global state for Drag and Drop
      let draggedActivityData = null; // Stores the data of the currently dragged activity
      let dragSourceElement = null; // Stores the DOM element being dragged

      // --- Drag and Drop Handlers ---

      function handleDragStart(e) {
        // 1. è¨­ç½®æ‹–æ›³æ•¸æ“š (ç”¨æ–¼è­˜åˆ¥æ´»å‹•)
        draggedActivityData = {
          itineraryId: e.currentTarget.dataset.itineraryId,
          dayIndex: parseInt(e.currentTarget.dataset.dayIndex),
          activityIndex: parseInt(e.currentTarget.dataset.activityIndex),
        };

        dragSourceElement = e.currentTarget;

        // å¿…é ˆè¨­å®š dataTransfer æ‰èƒ½è§¸ç™¼ drop äº‹ä»¶
        e.dataTransfer.setData(
          "text/plain",
          JSON.stringify(draggedActivityData)
        );
        e.dataTransfer.effectAllowed = "move";

        // 2. åŠ å…¥è¦–è¦ºæ•ˆæœï¼šåŠé€æ˜
        setTimeout(() => {
          e.currentTarget.classList.add("opacity-30");
        }, 0);
      }

      function handleDragOver(e) {
        e.preventDefault(); // å…è¨±æ”¾ä¸‹æ“ä½œ
        e.dataTransfer.dropEffect = "move";

        const target = e.currentTarget;
        const isActivityItem = target.classList.contains("activity-item");

        // åŠ å…¥è¦–è¦ºæŒ‡æ¨™åˆ°æ½›åœ¨çš„æ”¾ç½®ç›®æ¨™
        if (isActivityItem && target !== dragSourceElement) {
          target.classList.add("drag-target");
        }
      }

      function handleDragLeave(e) {
        // ç§»é™¤è¦–è¦ºæŒ‡æ¨™
        e.currentTarget.classList.remove("drag-target");
      }

      function handleDrop(e) {
        e.preventDefault();
        const dropTarget = e.currentTarget;

        // ç§»é™¤æ‰€æœ‰è¦–è¦ºæŒ‡æ¨™
        document.querySelectorAll(".activity-item").forEach((item) => {
          item.classList.remove("drag-target");
        });

        if (dragSourceElement !== dropTarget && draggedActivityData) {
          const targetItineraryId = dropTarget.dataset.itineraryId;
          const targetDayIndex = parseInt(dropTarget.dataset.dayIndex);
          const targetActivityIndex = parseInt(
            dropTarget.dataset.activityIndex
          );

          // æª¢æŸ¥æ˜¯å¦åœ¨åŒä¸€å¤©å…§æ‹–æ›³
          if (
            draggedActivityData.itineraryId === targetItineraryId &&
            draggedActivityData.dayIndex === targetDayIndex
          ) {
            const itinerary = appState.mockItineraries.find(
              (i) => i.id === targetItineraryId
            );
            const activities = itinerary.days[targetDayIndex].activities;

            const draggedIndex = draggedActivityData.activityIndex;
            const dropIndex = targetActivityIndex;

            // --- NEW LOGIC: Time Slot Shift ---

            // 1. å„²å­˜æ‰€æœ‰æ´»å‹•çš„åŸå§‹æ™‚é–“é †åº
            const originalTimes = activities.map((activity) => activity.time);

            // 2. åŸ·è¡Œè³‡æ–™é™£åˆ—ä¸­çš„ç§»å‹•æ“ä½œ (æ´»å‹•ç‰©ä»¶æœ¬èº«è¢«ç§»å‹•)
            // splice(start, deleteCount) returns an array containing the deleted elements.
            const [movedActivity] = activities.splice(draggedIndex, 1);
            // splice(start, deleteCount, item1, item2, ...)
            activities.splice(dropIndex, 0, movedActivity);

            // 3. é‡æ–°åˆ†é…æ™‚é–“ï¼šå°‡åŸå§‹æ™‚é–“é †åºè³¦äºˆçµ¦æ–°çš„æ´»å‹•åˆ—è¡¨
            // é€™æ¨£ä¸€ä¾†ï¼Œæ™‚é–“å°±æœƒè·Ÿéš¨ã€Œä½ç½®/æ™‚æ®µã€ç§»å‹•
            activities.forEach((activity, index) => {
              activity.time = originalTimes[index];
            });

            // --- END NEW LOGIC ---

            // é‡æ–°æ¸²æŸ“è©²å¤©çš„è¡Œç¨‹ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„é †åºå’Œæ™‚é–“
            switchItineraryDay(targetItineraryId, targetDayIndex);
          } else {
            console.warn("ç›®å‰åƒ…æ”¯æ´åŒä¸€å¤©çš„æ´»å‹•æ‹–æ›³ã€‚");
          }
        }

        // æ¸…é™¤æ‹–æ›³ç‹€æ…‹
        draggedActivityData = null;
        dragSourceElement = null;
      }

      function handleDragEnd(e) {
        // ç§»é™¤åŠé€æ˜æ•ˆæœ
        e.currentTarget.classList.remove("opacity-30");

        // ç¢ºä¿æ‰€æœ‰æ”¾ç½®ç›®æ¨™çš„æ¨£å¼éƒ½è¢«æ¸…é™¤
        document.querySelectorAll(".activity-item").forEach((item) => {
          item.classList.remove("drag-target");
        });
      }

      // å‡½æ•¸ï¼šé™„åŠ æ‹–æ›³äº‹ä»¶ç›£è½å™¨åˆ°æ‰€æœ‰æ´»å‹•é …ç›®
      function attachDragListeners() {
        const items = document.querySelectorAll(".activity-item");
        items.forEach((item) => {
          // ç§»é™¤èˆŠçš„ç›£è½å™¨ä»¥é¿å…é‡è¤‡ï¼Œé›–ç„¶é€™è£¡å› ç‚ºæ¯æ¬¡éƒ½é‡æ–°æ¸²æŸ“ï¼Œé€™æ­¥é©Ÿä¸æ˜¯åš´æ ¼å¿…è¦çš„
          item.removeEventListener("dragstart", handleDragStart);
          item.removeEventListener("dragover", handleDragOver);
          item.removeEventListener("dragleave", handleDragLeave);
          item.removeEventListener("drop", handleDrop);
          item.removeEventListener("dragend", handleDragEnd);

          // é™„åŠ æ–°çš„ç›£è½å™¨
          item.addEventListener("dragstart", handleDragStart);
          item.addEventListener("dragover", handleDragOver);
          item.addEventListener("dragleave", handleDragLeave);
          item.addEventListener("drop", handleDrop);
          item.addEventListener("dragend", handleDragEnd);
        });
      }

      // --- Core Navigation and State Management ---

      function navigate(page) {
        appState.currentPage = page;
        // Update active state in sidebar
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));
        const activeNav = document.getElementById(`nav-${page}`);
        if (activeNav) activeNav.classList.add("active");
        renderApp();
        window.scrollTo(0, 0);
      }

      // --- Utility Functions for Itinerary Detail Modal & Activity Editing ---

      // å‡½æ•¸ï¼šç”Ÿæˆæ´»å‹•ç·¨è¼¯å™¨çš„ HTML
      const getEditorHtml = (itineraryId, dayIndex) => {
        return `
                <div id="activity-editor" class="bg-indigo-50 p-4 rounded-xl shadow-inner border border-indigo-200 mb-4">
                    <h5 class="font-bold text-indigo-600 mb-3">æ–°å¢ç•¶æ—¥æ´»å‹•</h5>
                    <form id="add-activity-form" onsubmit="event.preventDefault(); addActivity('${itineraryId}', ${dayIndex});">
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <!-- Time Input -->
                            <div class="col-span-1">
                                <label for="activity-time" class="block text-xs font-medium text-gray-700">æ™‚é–“ (e.g., 09:30)</label>
                                <input type="text" id="activity-time" required class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="10:00">
                            </div>
                            <!-- Icon Input (Simplified) -->
                            <div class="col-span-1">
                                <label for="activity-icon" class="block text-xs font-medium text-gray-700">åœ–ç¤º (e.g., coffee, map-pin)</label>
                                <!-- Default value set to map-pin (Lucide icon names) -->
                                <input type="text" id="activity-icon" required class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" value="map-pin">
                            </div>
                        </div>
                        <!-- Name Input -->
                        <div class="mb-3">
                            <label for="activity-name" class="block text-xs font-medium text-gray-700">æ´»å‹•åç¨±</label>
                            <input type="text" id="activity-name" required class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="æ•…å®®åšç‰©é™¢">
                        </div>
                        <!-- Description Input -->
                        <div class="mb-4">
                            <label for="activity-description" class="block text-xs font-medium text-gray-700">æ´»å‹•æè¿° (é¸å¡«)</label>
                            <textarea id="activity-description" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="åƒè§€æ¸…å®®æ–‡ç‰©ï¼Œé è¨ˆåœç•™ 2 å°æ™‚"></textarea>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="toggleActivityEditor('${itineraryId}', ${dayIndex}, true)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition text-sm font-semibold">å–æ¶ˆ</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm font-semibold">å„²å­˜æ´»å‹•</button>
                        </div>
                    </form>
                </div>
            `;
      };

      // å‡½æ•¸ï¼šåˆ‡æ›æ´»å‹•ç·¨è¼¯å™¨ (é¡¯ç¤º/éš±è—)
      function toggleActivityEditor(itineraryId, dayIndex, hideOnly = false) {
        const editorContainer = document.getElementById(
          "activity-editor-container"
        );
        const addButton = document.getElementById("add-activity-btn");

        if (!editorContainer || !addButton) return;

        // Check if editor is currently empty (hidden state)
        const isEditorHidden = editorContainer.children.length === 0;

        if (isEditorHidden && !hideOnly) {
          // Show editor
          editorContainer.innerHTML = getEditorHtml(itineraryId, dayIndex);
          editorContainer.style.maxHeight = editorContainer.scrollHeight + "px"; // Expand height
          editorContainer.style.padding = "1rem 0"; // Restore vertical padding
          addButton.style.display = "none";
          // Remove potential previous error messages
          document.getElementById("validation-error")?.remove();
          // Focus on the first input field
          document.getElementById("activity-time").focus();
          lucide.createIcons(); // Ensure icons in the editor form are rendered
        } else {
          // Hide editor
          editorContainer.style.maxHeight = "0";
          editorContainer.style.padding = "0";
          // Wait for transition to finish before clearing content
          setTimeout(() => {
            editorContainer.innerHTML = "";
            addButton.style.display = "flex";
          }, 300); // Match CSS transition duration
        }
      }

      // å‡½æ•¸ï¼šè™•ç†è¡¨å–®æäº¤ä¸¦æ–°å¢æ´»å‹•åˆ°æ•¸æ“šä¸­
      function addActivity(itineraryId, dayIndex) {
        const time = document.getElementById("activity-time").value.trim();
        const icon =
          document.getElementById("activity-icon").value.trim() || "map-pin";
        const name = document.getElementById("activity-name").value.trim();
        const description = document
          .getElementById("activity-description")
          .value.trim();

        // ç°¡å–®çš„é©—è­‰
        if (!time || !name) {
          let errorEl = document.getElementById("validation-error");
          if (!errorEl) {
            document
              .querySelector("#add-activity-form")
              .insertAdjacentHTML(
                "beforebegin",
                '<div id="validation-error" class="text-red-600 bg-red-100 p-2 rounded-md mb-2 text-sm">è«‹å¡«å¯«æ™‚é–“å’Œæ´»å‹•åç¨±ã€‚</div>'
              );
            errorEl = document.getElementById("validation-error");
          }
          setTimeout(() => errorEl?.remove(), 3000);
          return;
        }

        const itinerary = appState.mockItineraries.find(
          (i) => i.id === itineraryId
        );
        if (!itinerary || !itinerary.days || !itinerary.days[dayIndex]) {
          console.error("æ‰¾ä¸åˆ°è¡Œç¨‹æˆ–æ—¥æœŸã€‚");
          return;
        }

        const newActivity = { time, icon, name, description };

        // å°‡æ–°æ´»å‹•æ¨åˆ°åˆ—è¡¨æœ«ç«¯ (è®“ç”¨æˆ¶è‡ªå·±æ‹–æ›³æ’åº)
        itinerary.days[dayIndex].activities.push(newActivity);
        // *** ç§»é™¤è‡ªå‹•æ’åºï¼Œå› ç‚ºç¾åœ¨ä½¿ç”¨æ‹–æ›³åŠŸèƒ½ ***
        // itinerary.days[dayIndex].activities.sort((a, b) => a.time.localeCompare(b.time));

        // 1. éš±è—ç·¨è¼¯å™¨
        toggleActivityEditor(itineraryId, dayIndex, true);

        // 2. é‡æ–°æ¸²æŸ“æ™‚é–“è»¸
        switchItineraryDay(itineraryId, dayIndex);

        console.log("æˆåŠŸæ–°å¢æ´»å‹•:", newActivity);
      }

      // å‡½æ•¸ï¼šæ ¹æ“šæ—¥æœŸæ•¸æ“šç”Ÿæˆæ´»å‹•æ™‚é–“è»¸çš„ HTML
      const generateTimelineHtml = (day, itineraryId, dayIndex) => {
        if (!day || !day.activities || day.activities.length === 0) {
          return `
                    <div class="p-4 text-center text-gray-400">é€™ä¸€å¤©æ²’æœ‰å®‰æ’æ´»å‹•ã€‚</div>
                    <!-- Activity Editor Insertion Point (Even if empty, for toggle function) -->
                    <div id="activity-editor-container" class="mt-4 transition-all duration-300 overflow-hidden" style="max-height: 0; padding: 0;"></div>
                    <button id="add-activity-btn" onclick="toggleActivityEditor('${itineraryId}', ${dayIndex})" class="mt-4 text-indigo-600 font-bold hover:text-indigo-800 transition flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-1"></i>
                        <span>æ–°å¢æ´»å‹•</span>
                    </button>
                `;
        }

        // Render activities
        // *** åŠ ä¸Š draggable="true", data-activity-index å’Œ cursor-move ***
        const activitiesHtml = day.activities
          .map(
            (activity, index) => `
                <div class="activity-item relative pl-8 pb-8 cursor-move" 
                     draggable="true" 
                     data-itinerary-id="${itineraryId}" 
                     data-day-index="${dayIndex}" 
                     data-activity-index="${index}">
                    <!-- Timeline Marker (Dot) -->
                    <div class="absolute left-0 top-0 w-4 h-4 rounded-full bg-indigo-500 border-4 border-white z-10"></div>
                    <!-- Timeline Line -->
                    <div class="absolute left-[7px] top-0 bottom-0 w-0.5 bg-indigo-200"></div>

                    <div class="activity-content ml-4 p-2 -my-2 rounded-md transition duration-200">
                        <div class="flex items-center space-x-2 text-sm text-gray-500 mb-1">
                            <!-- åœ–ç¤º (Icon) - Use activity.icon -->
                            <i data-lucide="${activity.icon || "map-pin"}" class="w-4 h-4 text-indigo-500"></i>
                            <span class="font-bold text-indigo-600">${activity.time}</span>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">${activity.name}</h4>
                        <p class="text-sm text-gray-600">${activity.description}</p>
                    </div>
                </div>
            `
          )
          .join("");

        return `
                <div class="relative ml-4">
                    ${activitiesHtml}
                    <!-- End Marker -->
                    <div class="absolute left-0 bottom-0 w-4 h-4 rounded-full bg-gray-300 border-4 border-white z-10"></div>
                </div>
                
                <!-- Activity Editor Insertion Point -->
                <div id="activity-editor-container" class="mt-4 transition-all duration-300 overflow-hidden" style="max-height: 0; padding: 0;"></div>

                <!-- Button now calls the editor toggle function -->
                <button id="add-activity-btn" onclick="toggleActivityEditor('${itineraryId}', ${dayIndex})" class="mt-4 text-indigo-600 font-bold hover:text-indigo-800 transition flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-1"></i>
                    <span>æ–°å¢æ´»å‹•</span>
                </button>
            `;
      };

      // å‡½æ•¸ï¼šåˆ‡æ›è¡Œç¨‹è©³æƒ…æ¨¡æ…‹æ¡†å…§é¡¯ç¤ºçš„æ—¥æœŸå…§å®¹ (ç¾åœ¨éœ€è¦ itineraryId)
      function switchItineraryDay(itineraryId, dayIndex) {
        const itinerary = appState.mockItineraries.find(
          (i) => i.id === itineraryId
        );
        if (!itinerary || !itinerary.days || !itinerary.days[dayIndex]) return;

        const day = itinerary.days[dayIndex];
        const container = document.getElementById(
          "itinerary-timeline-container"
        );
        const tabContainer = document.getElementById("day-tabs-container");

        if (container) {
          // 1. æ¸²æŸ“æ–°ä¸€å¤©çš„æ™‚é–“è»¸å…§å®¹ï¼Œä¸¦å‚³é itineraryId å’Œ dayIndex
          container.innerHTML = generateTimelineHtml(
            day,
            itineraryId,
            dayIndex
          );

          // 2. æ›´æ–°æ´»èºæ¨™ç±¤çš„æ¨£å¼
          if (tabContainer) {
            tabContainer.querySelectorAll("span").forEach((tab, index) => {
              if (index === dayIndex) {
                tab.className =
                  "flex-shrink-0 px-3 py-1 bg-indigo-600 text-white text-sm font-bold rounded-full cursor-pointer shadow-md transition";
              } else {
                tab.className =
                  "flex-shrink-0 px-3 py-1 bg-gray-100 text-gray-600 text-sm font-semibold rounded-full cursor-pointer hover:bg-gray-200 transition";
              }
            });
          }

          // 3. é‡æ–°å»ºç«‹ Lucide åœ–ç¤ºï¼Œç¢ºä¿æ–°æ¸²æŸ“çš„å…§å®¹åœ–ç¤ºæ­£ç¢ºé¡¯ç¤º
          lucide.createIcons();

          // 4. é™„åŠ æ‹–æ›³äº‹ä»¶ç›£è½å™¨åˆ°æ–°çš„æ´»å‹•é …ç›®
          attachDragListeners();
        }
      }

      // --- Modal Logic & Content Generation ---

      const getModalContent = (type, itemId = null) => {
        if (type === "posting_choice") {
          return `
                    <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">ä½ æƒ³ç™¼å¸ƒä»€éº¼ï¼Ÿ</h3>
                        <div class="space-y-4">
                            <button onclick="openModal('post_editor', 'discussion')" class="w-full flex items-center p-4 bg-orange-50 hover:bg-orange-100 rounded-xl transition border border-orange-200">
                                <i data-lucide="message-square" class="w-6 h-6 text-orange-500 mr-4"></i>
                                <div>
                                    <p class="font-bold text-gray-800">ç™¼èµ·è¨è«–è©±é¡Œ</p>
                                    <p class="text-xs text-gray-500">åˆ†äº«ç¶“é©—æˆ–å°‹æ±‚å»ºè­°</p>
                                </div>
                            </button>
                            <button onclick="openModal('post_editor', 'find_traveler')" class="w-full flex items-center p-4 bg-green-50 hover:bg-green-100 rounded-xl transition border border-green-200">
                                <i data-lucide="users" class="w-6 h-6 text-green-500 mr-4"></i>
                                <div>
                                    <p class="font-bold text-gray-800">å°‹æ‰¾æ—…ä¼´</p>
                                    <p class="text-xs text-gray-500">æ‰¾åˆ°å¿—åŒé“åˆçš„å¤¥ä¼´</p>
                                </div>
                            </button>
                        </div>
                        <button onclick="closeModal()" class="mt-6 w-full text-sm text-gray-500 hover:text-gray-800">å–æ¶ˆ</button>
                    </div>
                `;
        }

        if (type === "post_editor" && itemId) {
          const postType = itemId; // 'discussion' or 'find_traveler'
          const postTypeName =
            postType === "discussion" ? "è¨è«–è©±é¡Œ" : "å°‹æ‰¾æ—…ä¼´";
          const buttonColorClass =
            postType === "discussion"
              ? "bg-orange-500 hover:bg-orange-600"
              : "bg-green-500 hover:bg-green-600";

          return `
                    <div class="bg-white rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">ç™¼èµ·${postTypeName}</h3>
                            <button onclick="closeModal()" class="p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- Title Input -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æ¨™é¡Œ</label>
                            <input 
                                type="text" 
                                id="post-title-input" 
                                placeholder="è¼¸å…¥æ¨™é¡Œ..." 
                                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none"
                            >
                        </div>

                        <!-- Content Input -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">å…§æ–‡</label>
                            <textarea 
                                id="post-content-input" 
                                placeholder="å¯«ä¸‹ä½ çš„å…§å®¹..." 
                                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none resize-none" 
                                rows="8"
                            ></textarea>
                            <div class="flex items-center justify-between mt-3">
                                <div class="flex items-center space-x-2 relative">
                                    <input type="file" id="post-image-upload" accept="image/*,video/*" class="hidden" onchange="insertImageToPostEditor(this)">
                                    <button onclick="document.getElementById('post-image-upload').click()" class="p-2 hover:bg-gray-100 rounded-full transition" title="æ’å…¥åœ–ç‰‡ã€å½±åƒ">
                                        <i data-lucide="image" class="w-5 h-5 text-gray-400"></i>
                                    </button>
                                    <input type="file" id="post-gif-upload" accept="image/gif" class="hidden" onchange="insertGifToPostEditor(this)">
                                    <button onclick="document.getElementById('post-gif-upload').click()" class="p-2 hover:bg-gray-100 rounded-full transition" title="æ’å…¥ GIF æª”æ¡ˆ">
                                        <i data-lucide="file-image" class="w-5 h-5 text-gray-400"></i>
                                    </button>
                                    <button onclick="showPostEditorEmojiPicker(event)" class="p-2 hover:bg-gray-100 rounded-full transition" title="æ’å…¥è¡¨æƒ…ç¬¦è™Ÿ">
                                        <i data-lucide="smile" class="w-5 h-5 text-gray-400"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                            <button onclick="closeModal()" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition font-semibold">
                                å–æ¶ˆ
                            </button>
                            <button onclick="submitPost('${postType}')" class="px-6 py-2 ${buttonColorClass} text-white rounded-full font-semibold transition">
                                ç™¼å¸ƒ
                            </button>
                        </div>
                    </div>

                    <!-- Emoji Picker Modal for Post Editor -->
                    <div id="emoji-picker-modal-post-editor" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/20" onclick="closePostEditorEmojiPicker(event)">
                        <div class="bg-white rounded-2xl shadow-2xl p-4 max-w-sm w-full mx-4" onclick="event.stopPropagation()">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-gray-800">é¸æ“‡è¡¨æƒ…ç¬¦è™Ÿ</h3>
                                <button onclick="closePostEditorEmojiPicker()" class="p-1 hover:bg-gray-100 rounded-full transition">
                                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                                </button>
                            </div>
                            <div class="max-h-64 overflow-y-auto">
                                <div class="grid grid-cols-8 gap-2">
                                    ${[
                                      "ğŸ˜€",
                                      "ğŸ˜ƒ",
                                      "ğŸ˜„",
                                      "ğŸ˜",
                                      "ğŸ˜†",
                                      "ğŸ˜…",
                                      "ğŸ¤£",
                                      "ğŸ˜‚",
                                      "ğŸ™‚",
                                      "ğŸ™ƒ",
                                      "ğŸ˜‰",
                                      "ğŸ˜Š",
                                      "ğŸ˜‡",
                                      "ğŸ¥°",
                                      "ğŸ˜",
                                      "ğŸ¤©",
                                      "ğŸ˜˜",
                                      "ğŸ˜—",
                                      "ğŸ˜š",
                                      "ğŸ˜™",
                                      "ğŸ˜‹",
                                      "ğŸ˜›",
                                      "ğŸ˜œ",
                                      "ğŸ¤ª",
                                      "ğŸ˜",
                                      "ğŸ¤‘",
                                      "ğŸ¤—",
                                      "ğŸ¤­",
                                      "ğŸ¤«",
                                      "ğŸ¤”",
                                      "ğŸ¤",
                                      "ğŸ¤¨",
                                      "ğŸ˜",
                                      "ğŸ˜‘",
                                      "ğŸ˜¶",
                                      "ğŸ˜",
                                      "ğŸ˜’",
                                      "ğŸ™„",
                                      "ğŸ˜¬",
                                      "ğŸ¤¥",
                                      "ğŸ˜Œ",
                                      "ğŸ˜”",
                                      "ğŸ˜ª",
                                      "ğŸ¤¤",
                                      "ğŸ˜´",
                                      "ğŸ˜·",
                                      "ğŸ¤’",
                                      "ğŸ¤•",
                                      "ğŸ¤¢",
                                      "ğŸ¤®",
                                      "ğŸ¤§",
                                      "ğŸ¥µ",
                                      "ğŸ¥¶",
                                      "ğŸ˜¶â€ğŸŒ«ï¸",
                                      "ğŸ˜µ",
                                      "ğŸ˜µâ€ğŸ’«",
                                      "ğŸ¤¯",
                                      "ğŸ¤ ",
                                      "ğŸ¥³",
                                      "ğŸ¥¸",
                                      "ğŸ˜",
                                      "ğŸ¤“",
                                      "ğŸ§",
                                      "ğŸ˜•",
                                      "ğŸ˜Ÿ",
                                      "ğŸ™",
                                      "â˜¹ï¸",
                                      "ğŸ˜®",
                                      "ğŸ˜¯",
                                      "ğŸ˜²",
                                      "ğŸ˜³",
                                      "ğŸ¥º",
                                      "ğŸ˜¦",
                                      "ğŸ˜§",
                                      "ğŸ˜¨",
                                      "ğŸ˜°",
                                      "ğŸ˜¥",
                                      "ğŸ˜¢",
                                      "ğŸ˜­",
                                      "ğŸ˜±",
                                      "ğŸ˜–",
                                      "ğŸ˜£",
                                      "ğŸ˜",
                                      "ğŸ˜“",
                                      "ğŸ˜©",
                                      "ğŸ˜«",
                                      "ğŸ¥±",
                                      "ğŸ˜¤",
                                      "ğŸ˜¡",
                                      "ğŸ˜ ",
                                      "ğŸ¤¬",
                                      "ğŸ˜ˆ",
                                      "ğŸ‘¿",
                                      "ğŸ’€",
                                      "â˜ ï¸",
                                      "ğŸ’©",
                                      "ğŸ¤¡",
                                      "ğŸ‘¹",
                                      "ğŸ‘º",
                                      "ğŸ‘»",
                                      "ğŸ‘½",
                                      "ğŸ‘¾",
                                      "ğŸ¤–",
                                      "ğŸ˜º",
                                      "ğŸ˜¸",
                                      "ğŸ˜¹",
                                      "ğŸ˜»",
                                      "ğŸ˜¼",
                                      "ğŸ˜½",
                                      "ğŸ™€",
                                      "ğŸ˜¿",
                                      "ğŸ˜¾",
                                    ]
                                      .map(
                                        (emoji) => `
                                      <button onclick="insertEmojiToPostEditor('${emoji}')" class="text-2xl hover:bg-gray-100 rounded-lg p-2 transition">${emoji}</button>
                                    `
                                      )
                                      .join("")}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        if (type === "filter_placeholder") {
          return `
                    <div id="filter-modal-content" class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
                        <i data-lucide="sliders" class="w-10 h-10 text-indigo-500 mx-auto mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">ç¯©é¸åŠŸèƒ½æç¤º</h3>
                        <p class="text-sm text-gray-600 mb-4">å…§å®¹å°‡æœƒæ ¹æ“šæ‚¨é¸æ“‡çš„ç¯©é¸æ¢ä»¶æ›´æ–° (ç›®å‰ç‚º UI ä½”ä½)</p>
                        <button onclick="closeModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700 transition">çŸ¥é“äº†</button>
                    </div>
                `;
        }

        if (type === "itinerary_detail" && itemId) {
          const itinerary = appState.mockItineraries.find(
            (i) => i.id === itemId
          );
          if (!itinerary) return `<div>æ‰¾ä¸åˆ°è¡Œç¨‹</div>`;

          // æ ¹æ“šæ‰€æœ‰å¤©æ•¸æ•¸æ“šï¼Œå‹•æ…‹ç”Ÿæˆæ—¥æœŸåˆ‡æ›æ¨™ç±¤
          const dayTabsHtml = (itinerary.days || [])
            .map(
              (day, index) => `
                    <span onclick="switchItineraryDay('${itinerary.id}', ${index})" 
                          class="flex-shrink-0 px-3 py-1 ${index === 0 ? "bg-indigo-600 text-white font-bold shadow-md" : "bg-gray-100 text-gray-600 font-semibold hover:bg-gray-200"} text-sm rounded-full cursor-pointer transition">
                        ${day.date}
                    </span>
                `
            )
            .join("");

          // Render packing list
          const packingList = itinerary.packingList || [];
          // *** FIX: ç¢ºä¿ category.items å­˜åœ¨ä¸”ç‚ºé™£åˆ— ***
          const packingListHtml = packingList
            .map((category) => {
              const items = category.items || [];
              return `
                        <h5 class="font-bold text-gray-700 mt-4 mb-2">${category.category}</h5>
                        ${items
                          .map(
                            (item) => `
                            <label class="flex items-center text-sm space-x-2 py-1 cursor-pointer hover:bg-gray-50 rounded-md px-2">
                                <input type="checkbox" ${item.checked ? "checked" : ""} class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                                <span class="${item.checked ? "line-through text-gray-400" : "text-gray-800"}">${item.name}</span>
                            </label>
                        `
                          )
                          .join("")}
                    `;
            })
            .join("");

          return `
                    <div class="bg-white rounded-3xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto custom-scrollbar relative shadow-2xl">
                        <!-- Close Button -->
                        <button onclick="closeModal()" class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition z-50">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Header -->
                        <h2 class="text-3xl font-extrabold text-indigo-600 mb-6 flex items-center">
                            <i data-lucide="map" class="w-8 h-8 mr-3"></i> ${itinerary.title}
                        </h2>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Left: Timeline (2/3 width) -->
                            <div class="lg:col-span-2 bg-gray-50 p-5 rounded-2xl border border-gray-100">
                                <div class="flex items-center justify-between mb-4 border-b pb-3">
                                    <div class="flex items-center space-x-2 text-gray-600">
                                        <i data-lucide="calendar" class="w-5 h-5 text-green-500"></i>
                                        <span class="font-semibold">${itinerary.startDate} - ${itinerary.endDate}</span>
                                    </div>
                                    <button class="text-red-500 hover:text-red-700 transition" onclick="openModal('future_feature', 'åˆªé™¤è¡Œç¨‹')">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                
                                <!-- Day Selection Tabs (Dynamic) -->
                                <div id="day-tabs-container" class="flex space-x-2 mb-6 overflow-x-auto pb-2 custom-scrollbar">
                                    ${dayTabsHtml}
                                </div>

                                <!-- Activities Timeline Placeholder (Content loaded by switchItineraryDay) -->
                                <div id="itinerary-timeline-container" class="relative">
                                    <div class="p-4 text-center text-gray-400">è¼‰å…¥ä¸­...</div>
                                </div>
                            </div>

                            <!-- Right: Packing List (1/3 width) -->
                            <div class="lg:col-span-1 bg-white p-5 rounded-2xl border-4 border-gray-800 shadow-[4px_4px_0px_0px_rgba(31,41,55,1)]">
                                <div class="flex justify-between items-center mb-4 border-b pb-3">
                                    <h3 class="font-extrabold text-xl text-gray-800 flex items-center">
                                        <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-green-600"></i>
                                        æ‰€éœ€ç‰©å“
                                    </h3>
                                    <button class="text-green-600 hover:text-green-800"><i data-lucide="plus" class="w-5 h-5"></i></button>
                                </div>
                                <div class="text-sm">
                                    ${packingListHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        if (type === "itinerary_edit") {
          const isNew = !itemId;
          const itinerary = isNew
            ? {
                id: null,
                title: "",
                startDate: "",
                endDate: "",
                status: "planning",
                days: [
                  {
                    date: "Day 1",
                    activities: [],
                  },
                ],
                packingList: [
                  {
                    category: "è­‰ä»¶",
                    items: [],
                  },
                ],
              }
            : appState.mockItineraries.find((i) => i.id === itemId);

          if (!itinerary) return `<div>æ‰¾ä¸åˆ°è¡Œç¨‹</div>`;

          // Get current edit day index
          const currentDayIndex = appState.currentEditDayIndex || 0;

          // Generate day tabs
          const dayTabsHtml = (itinerary.days || [])
            .map(
              (day, index) => `
              <div class="flex items-center space-x-1">
                <input type="text" value="${day.date || `Day ${index + 1}`}" 
                       onclick="event.stopPropagation(); switchEditItineraryDay(${index})" 
                       onchange="updateDayDate(${index}, this.value)"
                       class="flex-shrink-0 px-3 py-1 ${index === currentDayIndex ? "bg-indigo-600 text-white font-bold shadow-md" : "bg-gray-100 text-gray-600 font-semibold hover:bg-gray-200"} text-sm rounded-full cursor-pointer transition border-none focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       style="width: auto; min-width: 80px;">
              </div>
            `
            )
            .join("");

          // Generate activities for current day
          const currentDay =
            itinerary.days && itinerary.days[currentDayIndex]
              ? itinerary.days[currentDayIndex]
              : { activities: [] };
          const activitiesHtml = currentDay.activities
            ? currentDay.activities
                .map(
                  (activity, index) => `
                <div class="activity-item-edit relative pl-8 pb-4 mb-4 border-b border-gray-200">
                  <div class="flex items-start space-x-3">
                    <div class="flex-1">
                      <div class="flex items-center space-x-2 mb-2">
                        <input type="text" value="${activity.time || ""}" placeholder="æ™‚é–“ (e.g., 09:00)" 
                               class="w-24 px-2 py-1 border border-gray-300 rounded text-sm" 
                               onchange="updateActivity(${index}, 'time', this.value)">
                        <input type="text" value="${activity.icon || "map-pin"}" placeholder="åœ–ç¤º" 
                               class="w-24 px-2 py-1 border border-gray-300 rounded text-sm" 
                               onchange="updateActivity(${index}, 'icon', this.value)">
                      </div>
                      <input type="text" value="${activity.name || ""}" placeholder="æ´»å‹•åç¨±" 
                             class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 font-semibold" 
                             onchange="updateActivity(${index}, 'name', this.value)">
                      <textarea placeholder="æ´»å‹•æè¿°" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                                rows="2" 
                                onchange="updateActivity(${index}, 'description', this.value)">${activity.description || ""}</textarea>
                    </div>
                    <button onclick="removeActivity(${index})" class="p-2 text-red-500 hover:bg-red-50 rounded-full">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>
              `
                )
                .join("")
            : "";

          // Generate packing list
          const packingListHtml = (itinerary.packingList || [])
            .map(
              (category, catIndex) => `
                <div class="mb-4">
                  <div class="flex items-center justify-between mb-2">
                    <input type="text" value="${category.category || ""}" placeholder="åˆ†é¡åç¨±" 
                           class="font-bold text-gray-700 border-b-2 border-transparent focus:border-indigo-500 focus:outline-none px-1" 
                           onchange="updatePackingCategory(${catIndex}, this.value)">
                    <button onclick="removePackingCategory(${catIndex})" class="text-red-500 hover:text-red-700 text-sm">
                      <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                  </div>
                  <div id="packing-items-${catIndex}" class="space-y-1">
                    ${(category.items || [])
                      .map(
                        (item, itemIndex) => `
                      <div class="flex items-center space-x-2">
                        <input type="checkbox" ${item.checked ? "checked" : ""} 
                               onchange="updatePackingItem(${catIndex}, ${itemIndex}, 'checked', this.checked)"
                               class="w-4 h-4 text-indigo-600 rounded">
                        <input type="text" value="${item.name || ""}" placeholder="ç‰©å“åç¨±" 
                               class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm" 
                               onchange="updatePackingItem(${catIndex}, ${itemIndex}, 'name', this.value)">
                        <button onclick="removePackingItem(${catIndex}, ${itemIndex})" class="text-red-500 hover:text-red-700">
                          <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                      </div>
                    `
                      )
                      .join("")}
                    <button onclick="addPackingItem(${catIndex})" class="text-sm text-indigo-600 hover:text-indigo-800 mt-2">
                      <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i> æ–°å¢ç‰©å“
                    </button>
                  </div>
                </div>
              `
            )
            .join("");

          return `
            <div class="bg-white rounded-3xl p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto custom-scrollbar relative shadow-2xl">
              <!-- Close Button -->
              <button onclick="closeModal()" class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition z-50">
                <i data-lucide="x" class="w-6 h-6"></i>
              </button>
              
              <!-- Header -->
              <div class="mb-6">
                <h2 class="text-3xl font-extrabold text-indigo-600 mb-4 flex items-center">
                  <i data-lucide="map" class="w-8 h-8 mr-3"></i>
                  <input type="text" id="edit-itinerary-title" value="${itinerary.title || ""}" placeholder="è¡Œç¨‹æ¨™é¡Œ" 
                         class="flex-1 text-3xl font-extrabold text-indigo-600 border-b-2 border-indigo-200 focus:border-indigo-500 focus:outline-none">
                </h2>
                
                <!-- Date Inputs -->
                <div class="flex items-center space-x-4 mb-4">
                  <div class="flex items-center space-x-2">
                    <i data-lucide="calendar" class="w-5 h-5 text-green-500"></i>
                    <input type="text" id="edit-itinerary-start" value="${itinerary.startDate || ""}" placeholder="é–‹å§‹æ—¥æœŸ (e.g., 2024.12.20)" 
                           class="px-3 py-2 border border-gray-300 rounded-lg">
                    <span class="text-gray-400">-</span>
                    <input type="text" id="edit-itinerary-end" value="${itinerary.endDate || ""}" placeholder="çµæŸæ—¥æœŸ (e.g., 2024.12.24)" 
                           class="px-3 py-2 border border-gray-300 rounded-lg">
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left: Timeline (2/3 width) -->
                <div class="lg:col-span-2 bg-gray-50 p-5 rounded-2xl border border-gray-100">
                  <!-- Day Selection Tabs -->
                  <div id="edit-day-tabs-container" class="flex space-x-2 mb-6 overflow-x-auto pb-2 custom-scrollbar">
                    ${dayTabsHtml}
                    <button onclick="addNewDay()" class="flex-shrink-0 px-3 py-1 bg-gray-200 text-gray-600 text-sm font-semibold rounded-full cursor-pointer hover:bg-gray-300 transition">
                      <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> æ–°å¢å¤©æ•¸
                    </button>
                  </div>

                  <!-- Activities Timeline -->
                  <div id="edit-itinerary-timeline-container" class="relative">
                    ${activitiesHtml || '<div class="p-4 text-center text-gray-400">é€™ä¸€å¤©æ²’æœ‰å®‰æ’æ´»å‹•ã€‚</div>'}
                    <button onclick="addNewActivity()" class="mt-4 text-indigo-600 font-bold hover:text-indigo-800 transition flex items-center">
                      <i data-lucide="plus" class="w-5 h-5 mr-1"></i>
                      <span>æ–°å¢æ´»å‹•</span>
                    </button>
                  </div>
                </div>

                <!-- Right: Packing List (1/3 width) -->
                <div class="lg:col-span-1 bg-white p-5 rounded-2xl border-4 border-gray-800 shadow-[4px_4px_0px_0px_rgba(31,41,55,1)]">
                  <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 class="font-extrabold text-xl text-gray-800 flex items-center">
                      <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-green-600"></i>
                      æ‰€éœ€ç‰©å“
                    </h3>
                    <button onclick="addPackingCategory()" class="text-green-600 hover:text-green-800">
                      <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                  </div>
                  <div class="text-sm" id="edit-packing-list-container">
                    ${packingListHtml || '<p class="text-gray-400 text-sm">é‚„æ²’æœ‰æ·»åŠ ç‰©å“åˆ†é¡</p>'}
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex items-center justify-end space-x-4 mt-6 pt-6 border-t border-gray-200">
                ${
                  !isNew
                    ? `
                  <button onclick="deleteItinerary('${itemId}')" class="px-6 py-2 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                    åˆªé™¤
                  </button>
                `
                    : ""
                }
                <button onclick="saveItinerary('${itemId || "new"}')" class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
                  <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                  å„²å­˜
                </button>
              </div>
            </div>
          `;
        }

        if (type === "post_detail" && itemId) {
          const postId = parseInt(itemId);
          const post = appState.mockPosts.find((p) => p.id === postId);
          if (!post)
            return `<div class="p-10 text-center text-gray-500">æ‰¾ä¸åˆ°æ–‡ç« </div>`;

          const isFavorited = appState.favorites.includes(postId);
          const isLiked = appState.likedPosts.includes(postId);
          const comments = appState.mockComments[postId] || [];
          const sortedComments = sortCommentsList(
            comments,
            appState.commentSort
          );

          const defaultAvatar =
            "https://placehold.co/100x100/A0BFFF/ffffff?text=User";
          const defaultPostImage =
            "https://placehold.co/800x400/94A3B8/ffffff?text=Post+Image";

          // Get translated post type name
          let postTypeName;
          if (post.type === "find_traveler") postTypeName = "æ‰¾æ—…ä¼´";
          else if (post.type === "featured_itinerary")
            postTypeName = "ç²¾é¸è¡Œç¨‹";
          else postTypeName = "è¨è«–å€";

          return `
            <div class="bg-white rounded-3xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto custom-scrollbar relative shadow-2xl">
              <!-- Close Button -->
              <button onclick="closeModal()" class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition z-50">
                <i data-lucide="x" class="w-6 h-6"></i>
              </button>

              <!-- Article Section -->
              <div class="mb-6">
                <!-- Title with Tags -->
                <div class="mb-4">
                  <div class="flex gap-2 mb-3">
                    ${post.tags
                      .map(
                        (t) =>
                          `<span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-lg font-semibold">#${t}</span>`
                      )
                      .join("")}
                  </div>
                  <h1 class="text-3xl font-bold text-gray-900 mb-4">${post.title}</h1>
                </div>

                <!-- Author Info -->
                <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-100">
                  <div class="flex items-center space-x-3">
                    <img src="${post.avatar}" onerror="this.onerror=null;this.src='${defaultAvatar}';" class="w-12 h-12 rounded-full object-cover">
                    <div>
                      <div class="flex items-center space-x-2">
                        <span class="font-bold text-gray-800">${post.author}</span>
                        ${post.spiritAnimal ? `<span class="text-xs font-semibold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">${post.spiritAnimal}</span>` : ""}
                        ${post.isAuthor ? `<span class="text-xs font-semibold text-orange-500 bg-orange-50 px-2 py-0.5 rounded-full">ä½œè€…</span>` : ""}
                      </div>
                      <div class="text-xs text-gray-400">${post.time} â€¢ ${postTypeName}</div>
                    </div>
                  </div>
                  <button class="px-4 py-2 bg-indigo-600 text-white rounded-full text-sm font-semibold hover:bg-indigo-700 transition">
                    è¿½è¹¤
                  </button>
                </div>

                <!-- Article Content -->
                <div class="mb-6">
                  <p class="text-gray-800 leading-relaxed whitespace-pre-line">${post.content}</p>
                </div>

                <!-- Post Image -->
                ${
                  post.image
                    ? `<div class="w-full rounded-xl overflow-hidden mb-6"><img src="${post.image}" onerror="this.onerror=null;this.src='${defaultPostImage}';" class="w-full h-auto object-cover"></div>`
                    : ""
                }

                <!-- Action Bar -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                  <div class="flex items-center space-x-6 text-gray-400">
                    <button onclick="toggleLike(${postId})" class="flex items-center space-x-2 hover:text-red-500 transition ${isLiked ? "text-red-500" : ""}">
                      <i data-lucide="heart" class="w-5 h-5 ${isLiked ? "fill-red-500" : ""}"></i>
                      <span class="text-sm font-semibold">${post.hearts}</span>
                    </button>
                    <button class="flex items-center space-x-2 hover:text-indigo-600 transition">
                      <i data-lucide="message-circle" class="w-5 h-5"></i>
                      <span class="text-sm font-semibold">${post.comments}</span>
                    </button>
                  </div>
                  <div class="flex items-center space-x-4">
                    <button onclick="toggleFavorite(${postId})" class="p-2 ${isFavorited ? "bg-red-500 text-white" : "hover:bg-gray-100"} rounded-full transition">
                      <i data-lucide="bookmark" class="w-5 h-5 ${isFavorited ? "fill-white" : "text-gray-400"}"></i>
                    </button>
                    <button class="p-2 hover:bg-gray-100 rounded-full transition">
                      <i data-lucide="share-2" class="w-5 h-5 text-gray-400"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Comments Section -->
              <div id="comments-section-${postId}" class="border-t border-gray-200 pt-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ç•™è¨€(${comments.length})</h2>
                
                <!-- Comment Input -->
                <div class="mb-4">
                  <textarea id="modal-comment-input-${postId}" placeholder="å¯«ä¸‹ä½ çš„ç•™è¨€..." class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none resize-none" rows="3"></textarea>
                  <div class="flex items-center justify-between mt-3">
                    <div class="flex items-center space-x-2 relative">
                      <input type="file" id="modal-image-upload-${postId}" accept="image/*,video/*" class="hidden" onchange="insertImageToModalComment(${postId}, this)">
                      <button onclick="document.getElementById('modal-image-upload-${postId}').click()" class="p-2 hover:bg-gray-100 rounded-full transition" title="æ’å…¥åœ–ç‰‡ã€å½±åƒ">
                        <i data-lucide="image" class="w-5 h-5 text-gray-400"></i>
                      </button>
                      <input type="file" id="modal-gif-upload-${postId}" accept="image/gif" class="hidden" onchange="insertGifToModalComment(${postId}, this)">
                      <button onclick="document.getElementById('modal-gif-upload-${postId}').click()" class="p-2 hover:bg-gray-100 rounded-full transition" title="æ’å…¥ GIF æª”æ¡ˆ">
                        <i data-lucide="file-image" class="w-5 h-5 text-gray-400"></i>
                      </button>
                      <button onclick="showModalEmojiPicker(${postId}, event)" class="p-2 hover:bg-gray-100 rounded-full transition" title="æ’å…¥è¡¨æƒ…ç¬¦è™Ÿ">
                        <i data-lucide="smile" class="w-5 h-5 text-gray-400"></i>
                      </button>
                    </div>
                    <button onclick="submitModalComment(${postId})" class="px-6 py-2 bg-indigo-600 text-white rounded-full font-semibold hover:bg-indigo-700 transition">
                      ç™¼è¡¨
                    </button>
                  </div>
                </div>
                
                <!-- Emoji Picker Modal (separate from button) -->
                <div id="emoji-picker-modal-${postId}" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/20" onclick="closeEmojiPickerModal(${postId}, event)">
                  <div class="bg-white rounded-2xl shadow-2xl p-4 max-w-sm w-full mx-4" onclick="event.stopPropagation()">
                    <div class="flex items-center justify-between mb-3">
                      <h3 class="text-lg font-semibold text-gray-800">é¸æ“‡è¡¨æƒ…ç¬¦è™Ÿ</h3>
                      <button onclick="closeEmojiPickerModal(${postId})" class="p-1 hover:bg-gray-100 rounded-full transition">
                        <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                      </button>
                    </div>
                    <div class="max-h-64 overflow-y-auto">
                      <div class="grid grid-cols-8 gap-2">
                        ${[
                          "ğŸ˜€",
                          "ğŸ˜ƒ",
                          "ğŸ˜„",
                          "ğŸ˜",
                          "ğŸ˜†",
                          "ğŸ˜…",
                          "ğŸ¤£",
                          "ğŸ˜‚",
                          "ğŸ™‚",
                          "ğŸ™ƒ",
                          "ğŸ˜‰",
                          "ğŸ˜Š",
                          "ğŸ˜‡",
                          "ğŸ¥°",
                          "ğŸ˜",
                          "ğŸ¤©",
                          "ğŸ˜˜",
                          "ğŸ˜—",
                          "ğŸ˜š",
                          "ğŸ˜™",
                          "ğŸ˜‹",
                          "ğŸ˜›",
                          "ğŸ˜œ",
                          "ğŸ¤ª",
                          "ğŸ˜",
                          "ğŸ¤‘",
                          "ğŸ¤—",
                          "ğŸ¤­",
                          "ğŸ¤«",
                          "ğŸ¤”",
                          "ğŸ¤",
                          "ğŸ¤¨",
                          "ğŸ˜",
                          "ğŸ˜‘",
                          "ğŸ˜¶",
                          "ğŸ˜",
                          "ğŸ˜’",
                          "ğŸ™„",
                          "ğŸ˜¬",
                          "ğŸ¤¥",
                          "ğŸ˜Œ",
                          "ğŸ˜”",
                          "ğŸ˜ª",
                          "ğŸ¤¤",
                          "ğŸ˜´",
                          "ğŸ˜·",
                          "ğŸ¤’",
                          "ğŸ¤•",
                          "ğŸ¤¢",
                          "ğŸ¤®",
                          "ğŸ¤§",
                          "ğŸ¥µ",
                          "ğŸ¥¶",
                          "ğŸ˜¶â€ğŸŒ«ï¸",
                          "ğŸ˜µ",
                          "ğŸ˜µâ€ğŸ’«",
                          "ğŸ¤¯",
                          "ğŸ¤ ",
                          "ğŸ¥³",
                          "ğŸ¥¸",
                          "ğŸ˜",
                          "ğŸ¤“",
                          "ğŸ§",
                          "ğŸ˜•",
                          "ğŸ˜Ÿ",
                          "ğŸ™",
                          "â˜¹ï¸",
                          "ğŸ˜®",
                          "ğŸ˜¯",
                          "ğŸ˜²",
                          "ğŸ˜³",
                          "ğŸ¥º",
                          "ğŸ˜¦",
                          "ğŸ˜§",
                          "ğŸ˜¨",
                          "ğŸ˜°",
                          "ğŸ˜¥",
                          "ğŸ˜¢",
                          "ğŸ˜­",
                          "ğŸ˜±",
                          "ğŸ˜–",
                          "ğŸ˜£",
                          "ğŸ˜",
                          "ğŸ˜“",
                          "ğŸ˜©",
                          "ğŸ˜«",
                          "ğŸ¥±",
                          "ğŸ˜¤",
                          "ğŸ˜¡",
                          "ğŸ˜ ",
                          "ğŸ¤¬",
                          "ğŸ˜ˆ",
                          "ğŸ‘¿",
                          "ğŸ’€",
                          "â˜ ï¸",
                          "ğŸ’©",
                          "ğŸ¤¡",
                          "ğŸ‘¹",
                          "ğŸ‘º",
                          "ğŸ‘»",
                          "ğŸ‘½",
                          "ğŸ‘¾",
                          "ğŸ¤–",
                          "ğŸ˜º",
                          "ğŸ˜¸",
                          "ğŸ˜¹",
                          "ğŸ˜»",
                          "ğŸ˜¼",
                          "ğŸ˜½",
                          "ğŸ™€",
                          "ğŸ˜¿",
                          "ğŸ˜¾",
                        ]
                          .map(
                            (emoji) => `
                          <button onclick="insertEmojiToModalComment(${postId}, '${emoji}')" class="text-2xl hover:bg-gray-100 rounded-lg p-2 transition">${emoji}</button>
                        `
                          )
                          .join("")}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Sort Buttons -->
                <div class="flex items-center space-x-2 mb-4 pb-4 border-b border-gray-100">
                  <button onclick="sortModalComments('hot', ${postId})" class="px-4 py-1.5 rounded-full text-sm font-semibold transition ${appState.commentSort === "hot" ? "bg-indigo-600 text-white" : "bg-gray-100 text-gray-600 hover:bg-gray-200"}">
                    ç†±é–€
                  </button>
                  <button onclick="sortModalComments('newest', ${postId})" class="px-4 py-1.5 rounded-full text-sm font-semibold transition ${appState.commentSort === "newest" ? "bg-indigo-600 text-white" : "bg-gray-100 text-gray-600 hover:bg-gray-200"}">
                    ç”±æ–°è‡³èˆŠ
                  </button>
                  <button onclick="sortModalComments('oldest', ${postId})" class="px-4 py-1.5 rounded-full text-sm font-semibold transition ${appState.commentSort === "oldest" ? "bg-indigo-600 text-white" : "bg-gray-100 text-gray-600 hover:bg-gray-200"}">
                    ç”±èˆŠè‡³æ–°
                  </button>
                </div>

                <!-- Comments List -->
                <div id="modal-comments-list-${postId}" class="space-y-6">
                  ${renderCommentsList(sortedComments, postId)}
                </div>
              </div>
            </div>
          `;
        }

        // Generic info modal for undeveloped features
        return `
                  <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
                      <i data-lucide="construction" class="w-10 h-10 text-yellow-500 mx-auto mb-4"></i>
                      <h3 class="text-xl font-bold text-gray-800 mb-2">åŠŸèƒ½é–‹ç™¼ä¸­</h3>
                      <p class="text-sm text-gray-600 mb-4">é€™å€‹åŠŸèƒ½å³å°‡ä¸Šç·šï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
                      <button onclick="closeModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700 transition">çŸ¥é“äº†</button>
                  </div>
              `;
      };

      function openModal(type, itemId = null) {
        const modal = document.getElementById("modal-container");
        modal.innerHTML = getModalContent(type, itemId);

        // Special handling for filter placeholder
        if (type === "filter_placeholder" && itemId) {
          document.querySelector("#filter-modal-content p").textContent =
            `æ‚¨é¸æ“‡äº† "${itemId}" ç¯©é¸ã€‚å…§å®¹å°‡æœƒæ›´æ–°ã€‚ (ç›®å‰ç‚º UI ä½”ä½)`;
        }

        modal.classList.remove("hidden");
        // Re-create lucide icons for modal content
        lucide.createIcons();

        // --- NEW: Initial rendering for Itinerary Detail ---
        if (type === "itinerary_detail" && itemId) {
          // ç¢ºä¿åœ¨æ¨¡æ…‹æ¡†çµæ§‹å·²ç¶“è¢«ç€è¦½å™¨è§£æå¾Œï¼Œæ‰å‘¼å«å‹•æ…‹å…§å®¹æ¸²æŸ“å‡½æ•¸
          setTimeout(() => {
            switchItineraryDay(itemId, 0); // è¼‰å…¥ç¬¬ä¸€å¤©çš„å…§å®¹ (Day 0)
          }, 10);
        }

        // Initialize edit itinerary state
        if (type === "itinerary_edit") {
          if (itemId) {
            const existing = appState.mockItineraries.find(
              (i) => i.id === itemId
            );
            appState.editingItinerary = existing
              ? JSON.parse(JSON.stringify(existing))
              : {
                  id: itemId,
                  title: "",
                  startDate: "",
                  endDate: "",
                  status: "planning",
                  days: [{ date: "Day 1", activities: [] }],
                  packingList: [{ category: "è­‰ä»¶", items: [] }],
                };
          } else {
            appState.editingItinerary = {
              id: null,
              title: "",
              startDate: "",
              endDate: "",
              status: "planning",
              days: [{ date: "Day 1", activities: [] }],
              packingList: [{ category: "è­‰ä»¶", items: [] }],
            };
          }
          appState.currentEditDayIndex = 0;
        }
      }

      function closeModal() {
        document.getElementById("modal-container").classList.add("hidden");
      }

      // Close modal when clicking outside
      document.getElementById("modal-container").onclick = (e) => {
        if (e.target === document.getElementById("modal-container"))
          closeModal();
      };

      // Modal comment functions
      function submitModalComment(postId) {
        const commentInput = document.getElementById(
          `modal-comment-input-${postId}`
        );
        const content = commentInput?.value.trim();
        if (!content) return;

        // In a real app, this would send to backend
        if (!appState.mockComments[postId]) {
          appState.mockComments[postId] = [];
        }

        const newComment = {
          id: `c${Date.now()}`,
          author: appState.currentUser.name,
          avatar: appState.currentUser.avatar,
          time: "å‰›å‰›",
          content: content,
          likes: 0,
          replies: [],
        };

        appState.mockComments[postId].push(newComment);
        commentInput.value = "";
        // Re-open modal to refresh comments
        openModal("post_detail", postId);
      }

      function sortModalComments(sortType, postId) {
        appState.commentSort = sortType;
        // Re-open modal to refresh comments
        openModal("post_detail", postId);
      }

      // Open post modal and scroll to comments section
      function openPostModalWithComments(postId) {
        openModal("post_detail", postId);
        // Wait for modal to render, then scroll to comments
        setTimeout(() => {
          const modal = document.getElementById("modal-container");
          const commentsSection = document.getElementById(
            `comments-section-${postId}`
          );
          if (commentsSection && modal) {
            // Scroll within the modal container
            const modalScrollContainer =
              modal.querySelector(".overflow-y-auto");
            if (modalScrollContainer) {
              const commentsOffset = commentsSection.offsetTop - 50; // Offset for better visibility
              modalScrollContainer.scrollTo({
                top: commentsOffset,
                behavior: "smooth",
              });
            } else {
              commentsSection.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
            // Focus on comment input
            setTimeout(() => {
              const commentInput = document.getElementById(
                `modal-comment-input-${postId}`
              );
              if (commentInput) {
                commentInput.focus();
              }
            }, 500);
          }
        }, 200);
      }

      // Insert image/video to modal comment
      function insertImageToModalComment(postId, input) {
        const file = input.files[0];
        if (!file) return;

        const commentInput = document.getElementById(
          `modal-comment-input-${postId}`
        );
        if (!commentInput) return;

        // Create a FileReader to read the file
        const reader = new FileReader();
        reader.onload = function (e) {
          const isVideo = file.type.startsWith("video/");
          const insertText = isVideo
            ? `\n[å½±ç‰‡: ${file.name}]\n`
            : `\n[åœ–ç‰‡: ${file.name}]\n`;

          const cursorPos = commentInput.selectionStart;
          const textBefore = commentInput.value.substring(0, cursorPos);
          const textAfter = commentInput.value.substring(cursorPos);
          commentInput.value = textBefore + insertText + textAfter;
          commentInput.focus();
          commentInput.setSelectionRange(
            cursorPos + insertText.length,
            cursorPos + insertText.length
          );
        };
        reader.readAsDataURL(file);
      }

      // Insert GIF to modal comment
      function insertGifToModalComment(postId, input) {
        const file = input.files[0];
        if (!file) return;

        const commentInput = document.getElementById(
          `modal-comment-input-${postId}`
        );
        if (!commentInput) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const insertText = `\n[GIF: ${file.name}]\n`;
          const cursorPos = commentInput.selectionStart;
          const textBefore = commentInput.value.substring(0, cursorPos);
          const textAfter = commentInput.value.substring(cursorPos);
          commentInput.value = textBefore + insertText + textAfter;
          commentInput.focus();
          commentInput.setSelectionRange(
            cursorPos + insertText.length,
            cursorPos + insertText.length
          );
        };
        reader.readAsDataURL(file);
      }

      // Show emoji picker modal for modal comment
      function showModalEmojiPicker(postId, event) {
        if (event) {
          event.stopPropagation();
        }
        // Close all other emoji pickers first
        document
          .querySelectorAll('[id^="emoji-picker-modal-"]')
          .forEach((picker) => {
            picker.classList.add("hidden");
          });
        const picker = document.getElementById(`emoji-picker-modal-${postId}`);
        if (picker) {
          picker.classList.remove("hidden");
          // Re-initialize lucide icons after showing
          setTimeout(() => {
            if (typeof lucide !== "undefined") {
              lucide.createIcons();
            }
          }, 10);
        }
      }

      // Close emoji picker modal
      function closeEmojiPickerModal(postId, event) {
        if (event) {
          event.stopPropagation();
        }
        const picker = document.getElementById(`emoji-picker-modal-${postId}`);
        if (picker) {
          picker.classList.add("hidden");
        }
      }

      // Insert emoji to modal comment
      function insertEmojiToModalComment(postId, emoji) {
        const commentInput = document.getElementById(
          `modal-comment-input-${postId}`
        );
        if (!commentInput) return;

        const cursorPos = commentInput.selectionStart;
        const textBefore = commentInput.value.substring(0, cursorPos);
        const textAfter = commentInput.value.substring(cursorPos);
        commentInput.value = textBefore + emoji + textAfter;
        commentInput.focus();
        commentInput.setSelectionRange(
          cursorPos + emoji.length,
          cursorPos + emoji.length
        );

        // Close emoji picker modal
        closeEmojiPickerModal(postId);
      }

      // --- Post Editor Functions ---

      // Insert image/video to post editor
      function insertImageToPostEditor(input) {
        const file = input.files[0];
        if (!file) return;

        const contentInput = document.getElementById("post-content-input");
        if (!contentInput) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const isVideo = file.type.startsWith("video/");
          const insertText = isVideo
            ? `\n[å½±ç‰‡: ${file.name}]\n`
            : `\n[åœ–ç‰‡: ${file.name}]\n`;

          const cursorPos = contentInput.selectionStart;
          const textBefore = contentInput.value.substring(0, cursorPos);
          const textAfter = contentInput.value.substring(cursorPos);
          contentInput.value = textBefore + insertText + textAfter;
          contentInput.focus();
          contentInput.setSelectionRange(
            cursorPos + insertText.length,
            cursorPos + insertText.length
          );
        };
        reader.readAsDataURL(file);
      }

      // Insert GIF to post editor
      function insertGifToPostEditor(input) {
        const file = input.files[0];
        if (!file) return;

        const contentInput = document.getElementById("post-content-input");
        if (!contentInput) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const insertText = `\n[GIF: ${file.name}]\n`;

          const cursorPos = contentInput.selectionStart;
          const textBefore = contentInput.value.substring(0, cursorPos);
          const textAfter = contentInput.value.substring(cursorPos);
          contentInput.value = textBefore + insertText + textAfter;
          contentInput.focus();
          contentInput.setSelectionRange(
            cursorPos + insertText.length,
            cursorPos + insertText.length
          );
        };
        reader.readAsDataURL(file);
      }

      // Show emoji picker for post editor
      function showPostEditorEmojiPicker(event) {
        if (event) {
          event.stopPropagation();
        }
        const picker = document.getElementById(
          "emoji-picker-modal-post-editor"
        );
        if (picker) {
          picker.classList.remove("hidden");
          setTimeout(() => {
            if (typeof lucide !== "undefined") {
              lucide.createIcons();
            }
          }, 10);
        }
      }

      // Close emoji picker for post editor
      function closePostEditorEmojiPicker(event) {
        if (event) {
          event.stopPropagation();
        }
        const picker = document.getElementById(
          "emoji-picker-modal-post-editor"
        );
        if (picker) {
          picker.classList.add("hidden");
        }
      }

      // Insert emoji to post editor
      function insertEmojiToPostEditor(emoji) {
        const contentInput = document.getElementById("post-content-input");
        if (!contentInput) return;

        const cursorPos = contentInput.selectionStart;
        const textBefore = contentInput.value.substring(0, cursorPos);
        const textAfter = contentInput.value.substring(cursorPos);
        contentInput.value = textBefore + emoji + textAfter;
        contentInput.focus();
        contentInput.setSelectionRange(
          cursorPos + emoji.length,
          cursorPos + emoji.length
        );

        // Close emoji picker modal
        closePostEditorEmojiPicker();
      }

      // Submit post
      function submitPost(postType) {
        const titleInput = document.getElementById("post-title-input");
        const contentInput = document.getElementById("post-content-input");

        if (!titleInput || !contentInput) return;

        const title = titleInput.value.trim();
        const content = contentInput.value.trim();

        if (!title) {
          alert("è«‹è¼¸å…¥æ¨™é¡Œ");
          return;
        }

        if (!content) {
          alert("è«‹è¼¸å…¥å…§å®¹");
          return;
        }

        // Create new post
        const newPost = {
          id: `p${Date.now()}`,
          title: title,
          content: content,
          author: appState.currentUser.name,
          avatar: appState.currentUser.avatar,
          time: "å‰›å‰›",
          hearts: 0,
          comments: 0,
          tags: postType === "discussion" ? ["è¨è«–"] : ["æ‰¾æ—…ä¼´"],
          image: null,
        };

        // Add to mock posts
        appState.mockPosts.unshift(newPost);

        // Close modal
        closeModal();

        // Navigate to appropriate page
        if (postType === "discussion") {
          navigate("discussion");
        } else {
          navigate("find_traveler");
        }

        // Show success message
        setTimeout(() => {
          alert("ç™¼æ–‡æˆåŠŸï¼");
        }, 100);
      }

      // --- Itinerary Edit Functions ---

      function switchEditItineraryDay(dayIndex) {
        appState.currentEditDayIndex = dayIndex;
        // Re-open modal to refresh
        const itineraryId = appState.editingItinerary?.id || null;
        openModal("itinerary_edit", itineraryId);
      }

      function updateDayDate(dayIndex, value) {
        if (!appState.editingItinerary || !appState.editingItinerary.days)
          return;
        const day = appState.editingItinerary.days[dayIndex];
        if (!day) return;
        day.date = value;
      }

      function updateActivity(activityIndex, field, value) {
        if (!appState.editingItinerary || !appState.editingItinerary.days)
          return;
        const day =
          appState.editingItinerary.days[appState.currentEditDayIndex];
        if (!day || !day.activities || !day.activities[activityIndex]) return;
        day.activities[activityIndex][field] = value;
      }

      function removeActivity(activityIndex) {
        if (!appState.editingItinerary || !appState.editingItinerary.days)
          return;
        const day =
          appState.editingItinerary.days[appState.currentEditDayIndex];
        if (!day || !day.activities) return;
        day.activities.splice(activityIndex, 1);
        const itineraryId = appState.editingItinerary?.id || null;
        openModal("itinerary_edit", itineraryId);
      }

      function addNewActivity() {
        if (!appState.editingItinerary || !appState.editingItinerary.days)
          return;
        const day =
          appState.editingItinerary.days[appState.currentEditDayIndex];
        if (!day) return;
        if (!day.activities) day.activities = [];
        day.activities.push({
          time: "",
          icon: "map-pin",
          name: "",
          description: "",
        });
        const itineraryId = appState.editingItinerary?.id || null;
        openModal("itinerary_edit", itineraryId);
      }

      function addNewDay() {
        if (!appState.editingItinerary) return;
        if (!appState.editingItinerary.days)
          appState.editingItinerary.days = [];
        const dayNumber = appState.editingItinerary.days.length + 1;
        appState.editingItinerary.days.push({
          date: `Day ${dayNumber}`,
          activities: [],
        });
        appState.currentEditDayIndex =
          appState.editingItinerary.days.length - 1;
        const itineraryId = appState.editingItinerary?.id || null;
        openModal("itinerary_edit", itineraryId);
      }

      function updatePackingItem(categoryIndex, itemIndex, field, value) {
        if (
          !appState.editingItinerary ||
          !appState.editingItinerary.packingList
        )
          return;
        const category = appState.editingItinerary.packingList[categoryIndex];
        if (!category || !category.items || !category.items[itemIndex]) return;
        category.items[itemIndex][field] = value;
      }

      function removePackingItem(categoryIndex, itemIndex) {
        if (
          !appState.editingItinerary ||
          !appState.editingItinerary.packingList
        )
          return;
        const category = appState.editingItinerary.packingList[categoryIndex];
        if (!category || !category.items) return;
        category.items.splice(itemIndex, 1);
        const itineraryId = appState.editingItinerary?.id || null;
        openModal("itinerary_edit", itineraryId);
      }

      function addPackingItem(categoryIndex) {
        if (
          !appState.editingItinerary ||
          !appState.editingItinerary.packingList
        )
          return;
        const category = appState.editingItinerary.packingList[categoryIndex];
        if (!category) return;
        if (!category.items) category.items = [];
        category.items.push({ name: "", checked: false });
        const itineraryId = appState.editingItinerary?.id || null;
        openModal("itinerary_edit", itineraryId);
      }

      function addPackingCategory() {
        if (!appState.editingItinerary) return;
        if (!appState.editingItinerary.packingList)
          appState.editingItinerary.packingList = [];
        appState.editingItinerary.packingList.push({
          category: "æ–°åˆ†é¡",
          items: [],
        });
        const itineraryId = appState.editingItinerary?.id || null;
        openModal("itinerary_edit", itineraryId);
      }

      function removePackingCategory(categoryIndex) {
        if (
          !appState.editingItinerary ||
          !appState.editingItinerary.packingList
        )
          return;
        appState.editingItinerary.packingList.splice(categoryIndex, 1);
        const itineraryId = appState.editingItinerary?.id || null;
        openModal("itinerary_edit", itineraryId);
      }

      function updatePackingCategory(categoryIndex, value) {
        if (
          !appState.editingItinerary ||
          !appState.editingItinerary.packingList
        )
          return;
        const category = appState.editingItinerary.packingList[categoryIndex];
        if (!category) return;
        category.category = value;
      }

      function saveItinerary(itineraryId) {
        if (!appState.editingItinerary) return;

        // Get values from inputs
        const title =
          document.getElementById("edit-itinerary-title")?.value || "";
        const startDate =
          document.getElementById("edit-itinerary-start")?.value || "";
        const endDate =
          document.getElementById("edit-itinerary-end")?.value || "";

        appState.editingItinerary.title = title;
        appState.editingItinerary.startDate = startDate;
        appState.editingItinerary.endDate = endDate;

        if (itineraryId === "new" || !itineraryId) {
          // Create new itinerary
          const newId = "i" + (appState.mockItineraries.length + 1);
          appState.editingItinerary.id = newId;
          appState.mockItineraries.push(appState.editingItinerary);
        } else {
          // Update existing itinerary
          const index = appState.mockItineraries.findIndex(
            (i) => i.id === itineraryId
          );
          if (index > -1) {
            appState.mockItineraries[index] = appState.editingItinerary;
          }
        }

        closeModal();
        // Refresh the page
        if (appState.currentPage === "my_itinerary") {
          renderApp();
        }
      }

      function deleteItinerary(itineraryId) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ")) return;

        const index = appState.mockItineraries.findIndex(
          (i) => i.id === itineraryId
        );
        if (index > -1) {
          appState.mockItineraries.splice(index, 1);
        }

        closeModal();
        // Refresh the page
        if (appState.currentPage === "my_itinerary") {
          renderApp();
        }
      }

      // --- Chat Window Functions ---

      function toggleChatWindow() {
        const chatWindow = document.getElementById("chat-window");
        // å¦‚æœç§äººèŠå¤©å®¤æ˜¯æ‰“å¼€çš„ï¼Œå…ˆå…³é—­å®ƒ
        const privateChatWindow = document.getElementById(
          "private-chat-window"
        );
        if (!privateChatWindow.classList.contains("hidden")) {
          privateChatWindow.classList.add("hidden");
        }

        if (chatWindow.classList.contains("hidden")) {
          chatWindow.classList.remove("hidden");
          // Re-create icons when opening
          lucide.createIcons();
          // Focus on input
          setTimeout(() => {
            document.getElementById("chat-input")?.focus();
          }, 100);
        } else {
          chatWindow.classList.add("hidden");
        }
      }

      function sendChatMessage() {
        const input = document.getElementById("chat-input");
        const messagesContainer = document.getElementById("chat-messages");
        const message = input.value.trim();

        if (!message) return;

        // Add user message
        const userMessageHtml = `
                <div class="flex items-start space-x-2 justify-end">
                    <div class="bg-orange-500 text-white rounded-2xl rounded-tr-sm p-3 shadow-sm max-w-[80%]">
                        <p class="text-sm">${message}</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="user" class="w-5 h-5 text-gray-600"></i>
                    </div>
                </div>
            `;
        messagesContainer.insertAdjacentHTML("beforeend", userMessageHtml);

        // Clear input
        input.value = "";

        // Re-create icons
        lucide.createIcons();

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Simulate bot response (you can replace this with actual API call)
        setTimeout(() => {
          const botResponseHtml = `
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm max-w-[80%]">
                            <p class="text-sm text-gray-800">æ„Ÿè¬æ‚¨çš„å•é¡Œï¼æˆ‘å·²ç¶“æ”¶åˆ°æ‚¨çš„è¨Šæ¯ã€‚é€™æ˜¯ä¸€å€‹ç¤ºç¯„å›æ‡‰ï¼Œæ‚¨å¯ä»¥æ ¹æ“šå¯¦éš›éœ€æ±‚é€£æ¥å¾Œç«¯ API ä¾†å¯¦ç¾çœŸæ­£çš„èŠå¤©åŠŸèƒ½ã€‚</p>
                        </div>
                    </div>
                `;
          messagesContainer.insertAdjacentHTML("beforeend", botResponseHtml);
          lucide.createIcons();
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 500);
      }

      // --- Private Chat Window Functions ---

      function togglePrivateChatWindow() {
        const privateChatWindow = document.getElementById(
          "private-chat-window"
        );
        // å¦‚æœAIåŠ©æ‰‹èŠå¤©å®¤æ˜¯æ‰“å¼€çš„ï¼Œå…ˆå…³é—­å®ƒ
        const aiChatWindow = document.getElementById("chat-window");
        if (!aiChatWindow.classList.contains("hidden")) {
          aiChatWindow.classList.add("hidden");
        }

        if (privateChatWindow.classList.contains("hidden")) {
          privateChatWindow.classList.remove("hidden");
          // Re-create icons when opening
          lucide.createIcons();
          // Focus on input
          setTimeout(() => {
            document.getElementById("private-chat-input")?.focus();
          }, 100);
        } else {
          privateChatWindow.classList.add("hidden");
        }
      }

      function sendPrivateChatMessage() {
        const input = document.getElementById("private-chat-input");
        const messagesContainer = document.getElementById(
          "private-chat-messages"
        );
        const message = input.value.trim();

        if (!message) return;

        // Add user message
        const userMessageHtml = `
                <div class="flex items-start space-x-2 justify-end">
                    <div class="bg-green-500 text-white rounded-2xl rounded-tr-sm p-3 shadow-sm max-w-[80%]">
                        <p class="text-sm">${message}</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="user" class="w-5 h-5 text-gray-600"></i>
                    </div>
                </div>
            `;
        messagesContainer.insertAdjacentHTML("beforeend", userMessageHtml);

        // Clear input
        input.value = "";

        // Re-create icons
        lucide.createIcons();

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Simulate response (you can replace this with actual API call)
        setTimeout(() => {
          const responseHtml = `
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="user" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm max-w-[80%]">
                            <p class="text-sm text-gray-800">å·²æ”¶åˆ°æ‚¨çš„è¨Šæ¯ï¼é€™æ˜¯ä¸€å€‹ç¤ºç¯„å›æ‡‰ï¼Œæ‚¨å¯ä»¥æ ¹æ“šå¯¦éš›éœ€æ±‚é€£æ¥å¾Œç«¯ API ä¾†å¯¦ç¾çœŸæ­£çš„ç§äººèŠå¤©åŠŸèƒ½ã€‚</p>
                        </div>
                    </div>
                `;
          messagesContainer.insertAdjacentHTML("beforeend", responseHtml);
          lucide.createIcons();
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 500);
      }

      // Function to generate the Search and Filter UI
      const getSearchFilterUI = (placeholder, filters) => {
        return `
                <div class="bg-white rounded-2xl p-4 mb-6 shadow-md border border-gray-100">
                    <div class="relative mb-4">
                        <input type="text" placeholder="${placeholder}" class="w-full py-3 pl-4 pr-12 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none transition text-sm">
                        <i data-lucide="search" class="absolute right-3 top-3.5 w-5 h-5 text-gray-400"></i>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${filters.map((f) => `<button onclick="filterContent('${f.id}', '${f.label}')" id="filter-${f.id}" class="text-sm px-4 py-1.5 rounded-full border border-gray-300 bg-white text-gray-600 hover:bg-indigo-50 hover:border-indigo-500 hover:text-indigo-600 transition">${f.label}</button>`).join("")}
                    </div>
                </div>
            `;
      };

      // Placeholder for filtering logic
      function filterContent(filterId, filterLabel) {
        // In a real app, this would update the content. Here it opens a modal.
        openModal("filter_placeholder", filterLabel);
      }

      // --- Content Rendering Components ---

      const renderArticle = (post) => {
        const isFind = post.type === "find_traveler";
        const isFavorited = appState.favorites.includes(post.id);
        const isLiked = appState.likedPosts.includes(post.id);

        const defaultAvatar =
          "https://placehold.co/100x100/A0BFFF/ffffff?text=User";
        const defaultPostImage =
          "https://placehold.co/800x400/94A3B8/ffffff?text=Post+Image";

        // Badge logic based on post type
        let statusBadge = "";
        if (isFind) {
          // Only "Find Traveler" posts show the remaining participants needed
          const needed = post.required - post.participants;
          statusBadge = `<span class="ml-auto bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold">å¾µ ${needed > 0 ? needed : 0} äºº</span>`;
        }

        // Get translated post type name
        let postTypeName;
        if (post.type === "find_traveler") postTypeName = "æ‰¾æ—…ä¼´";
        else if (post.type === "featured_itinerary") postTypeName = "ç²¾é¸è¡Œç¨‹";
        else postTypeName = "è¨è«–å€";

        return `
            <div class="bg-white rounded-2xl p-5 mb-6 shadow-sm border border-gray-100 hover:shadow-md transition relative">
                <div class="flex items-center space-x-3 mb-4">
                    <!-- User Avatar -->
                    <img src="${post.avatar}" onerror="this.onerror=null;this.src='${defaultAvatar}';" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <!-- Author and Spirit Animal -->
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-gray-800">${post.author}</span>
                            ${post.spiritAnimal ? `<span class="text-xs font-semibold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">${post.spiritAnimal}</span>` : ""}
                        </div>
                        <!-- Post Time and Type -->
                        <div class="text-xs text-gray-400">${post.time} â€¢ ${postTypeName}</div>
                    </div>
                    ${statusBadge}
                </div>
                <h3 onclick="openModal('post_detail', ${post.id})" class="text-lg font-bold text-gray-900 mb-2 cursor-pointer hover:text-indigo-600">${post.title}</h3>
                <p class="text-gray-600 text-sm mb-4 line-clamp-2">${post.content}</p>
                <!-- Post Image (Optional) -->
                ${post.image ? `<div class="w-full h-64 rounded-xl overflow-hidden mb-4"><img src="${post.image}" onerror="this.onerror=null;this.src='${defaultPostImage}';" class="w-full h-full object-cover hover:scale-105 transition duration-500"></div>` : ""}
                <!-- Tags -->
                <div class="flex gap-2 mb-4">
                    ${post.tags.map((t) => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-lg">#${t}</span>`).join("")}
                </div>
                <!-- Actions: Hearts, Comments, Share -->
                <div class="flex items-center text-gray-400 text-sm border-t border-gray-50 pt-3">
                    <button onclick="toggleLike(${post.id}); event.stopPropagation();" class="flex items-center space-x-1 hover:text-red-500 transition ${isLiked ? "text-red-500" : ""}">
                        <i data-lucide="heart" class="w-4 h-4 ${isLiked ? "fill-red-500" : ""}"></i> 
                        <span>${post.hearts}</span>
                    </button>
                    <button onclick="openPostModalWithComments(${post.id}); event.stopPropagation();" class="ml-6 flex items-center space-x-1 hover:text-indigo-600"><i data-lucide="message-circle" class="w-4 h-4"></i> <span>${post.comments}</span></button>
                    <button class="ml-auto"><i data-lucide="share2" class="w-4 h-4"></i></button>
                </div>
                <!-- Favorite Bookmark Button (Bottom Right) -->
                <button onclick="toggleFavorite(${post.id}); event.stopPropagation();" class="absolute bottom-5 right-5 p-2 ${isFavorited ? "bg-red-500 text-white" : "bg-gray-100 text-gray-400 hover:bg-gray-200"} rounded-full transition shadow-sm">
                    <i data-lucide="bookmark" class="w-4 h-4 ${isFavorited ? "fill-white" : ""}"></i>
                </button>
            </div>`;
      };

      const renderTravelerGridCard = (post) => {
        const defaultAvatar =
          "https://placehold.co/100x100/A0BFFF/ffffff?text=User";
        const defaultPostImage =
          "https://placehold.co/800x400/94A3B8/ffffff?text=Travel+Post";
        const needed = post.required - post.participants;
        const isFavorited = appState.favorites.includes(post.id);
        const isLiked = appState.likedPosts.includes(post.id);

        return `
            <div onclick="openModal('post_detail', ${post.id})" class="bg-white rounded-2xl overflow-hidden shadow-lg border border-gray-100 group flex flex-col hover:shadow-xl transition relative cursor-pointer">
                <!-- Image Area & Status Badge -->
                <div class="h-40 overflow-hidden relative">
                    <img src="${post.image || defaultPostImage}" onerror="this.onerror=null;this.src='${defaultPostImage}';" class="w-full h-full object-cover group-hover:scale-105 transition duration-700">
                    <span class="absolute top-3 right-3 bg-red-500 text-white text-xs px-2 py-1 rounded-full flex items-center shadow-md"><i data-lucide="users" class="w-3 h-3 mr-1"></i> å¾µ ${needed > 0 ? needed : 0} äºº</span>
                    <span class="absolute top-3 left-3 bg-white/90 backdrop-blur text-xs font-bold px-2 py-1 rounded-md text-gray-600 shadow-sm">${post.tags[0]}</span>
                </div>
                
                <div class="p-4 flex flex-col flex-grow">
                    <!-- Title -->
                    <h3 class="font-extrabold text-xl mb-3 text-gray-900 line-clamp-2">${post.title}</h3>
                    
                    <!-- Author/Spirit Animal & Location/Date -->
                    <div class="flex items-center justify-between mb-3 border-b pb-3 border-gray-100">
                        <!-- Left: Author -->
                        <div class="flex items-center space-x-3">
                            <img src="${post.avatar}" onerror="this.onerror=null;this.src='${defaultAvatar}';" class="w-8 h-8 rounded-full object-cover border-2 border-indigo-300">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-gray-700">${post.author}</span>
                                <span class="text-xs text-indigo-600 font-semibold">${post.spiritAnimal}</span>
                            </div>
                        </div>
                        <!-- Right: Location and Date -->
                        <div class="text-right text-xs text-gray-500 space-y-1">
                            <div class="flex items-center justify-end">
                                <i data-lucide="map-pin" class="w-3 h-3 mr-1 text-red-500"></i>
                                <span class="truncate" title="${post.location}">${post.location}</span>
                            </div>
                            <div class="flex items-center justify-end">
                                <i data-lucide="calendar" class="w-3 h-3 mr-1 text-green-500"></i>
                                <span class="truncate" title="${post.date}">${post.date}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Preview -->
                    <p class="text-gray-500 text-sm mb-4 line-clamp-3 flex-grow">${post.content}</p>

                    <!-- Action Button -->
                    <div class="mt-auto pt-3 border-t border-gray-100 flex justify-between items-center">
                        <button onclick="toggleLike(${post.id}); event.stopPropagation();" class="flex items-center text-xs hover:text-red-500 transition ${isLiked ? "text-red-500" : "text-gray-400"}">
                            <i data-lucide="heart" class="w-4 h-4 mr-1 ${isLiked ? "fill-red-500" : ""}"></i> ${post.hearts}
                        </button>
                        <button class="bg-indigo-600 text-white text-sm px-4 py-2 rounded-xl hover:bg-indigo-700 transition shadow-md hover:scale-[1.02]">
                            <i data-lucide="message-circle" class="w-4 h-4 mr-1 inline-block"></i>
                            æœ‰èˆˆè¶£
                        </button>
                    </div>
                </div>
                <!-- Favorite Bookmark Button (Bottom Right) -->
                <button onclick="toggleFavorite(${post.id}); event.stopPropagation();" class="absolute bottom-4 right-4 p-2 ${isFavorited ? "bg-red-500 text-white" : "bg-white/90 text-gray-400 hover:bg-gray-200"} rounded-full transition shadow-sm">
                    <i data-lucide="bookmark" class="w-4 h-4 ${isFavorited ? "fill-white" : ""}"></i>
                </button>
            </div>`;
      };

      // --- Render Pages ---

      const renderHome = () => {
        const travelers = appState.mockPosts.filter(
          (p) => p.type === "find_traveler"
        );
        const discussions = appState.mockPosts.filter(
          (p) => p.type === "discussion" || p.type === "featured_itinerary"
        );
        return `
            <div class="flex flex-col lg:flex-row gap-6">
                <div class="w-full lg:w-3/4">
                    <!-- Horizontal Scroll Section (Featured Travelers) -->
                    <div class="mb-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i data-lucide="sparkles" class="w-5 h-5 mr-2 text-yellow-500"></i> æ—…ä¼´æ¨è–¦</h2>
                        <div class="flex overflow-x-auto space-x-4 pb-4 custom-scrollbar snap-x">
                            ${travelers
                              .map((t) => {
                                const defaultImage =
                                  "https://placehold.co/800x400/5E8FF9/ffffff?text=Travel+Dream";
                                const imageUrl = t.image || defaultImage;
                                // Tailwind classes for dynamic background image
                                const backgroundStyle = `background-image: url('${imageUrl}'); background-size: cover; background-position: center;`;

                                return `
                                <div style="${backgroundStyle}"
                                    onclick="openModal('post_detail', ${t.id})"
                                    class="flex-shrink-0 w-72 h-48 rounded-[2rem] p-5 border-4 border-gray-800 shadow-[6px_6px_0px_0px_rgba(31,41,55,1)] snap-center cursor-pointer hover:-translate-y-1 transition relative overflow-hidden">
                                    
                                    <!-- Dark Overlay for readability -->
                                    <div class="absolute inset-0 bg-black/40 rounded-[1.8rem]"></div>

                                    <!-- Content -->
                                    <div class="relative z-10 h-full flex flex-col justify-between">
                                        <!-- Top Badges -->
                                        <div class="flex justify-between">
                                            <span class="bg-indigo-500/90 text-white border-2 border-white px-2 py-0.5 text-xs font-bold rounded -rotate-2">${t.tags[0]}</span>
                                            <span class="bg-red-500/90 text-white border-2 border-white px-2 py-0.5 text-xs font-bold rounded rotate-2">${t.participants}/${t.required}äºº</span>
                                        </div>

                                        <!-- Bottom Content -->
                                        <div class="text-center mt-auto">
                                            <h3 class="font-bold text-xl text-white leading-snug mb-3 line-clamp-2">${t.title}</h3>
                                            <button onclick="event.stopPropagation(); openModal('post_detail', ${t.id})" class="text-xs bg-white text-gray-800 border-2 border-gray-800 px-4 py-2 rounded-full font-extrabold hover:bg-gray-100 shadow-md transition">
                                                æ¢ç´¢è¡Œç¨‹
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                `;
                              })
                              .join("")}
                        </div>
                    </div>
                    <!-- Latest Articles -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4">æœ€æ–°å‹•æ…‹</h2>
                        ${discussions.map(renderArticle).join("")}
                    </div>
                </div>
                <!-- Sidebar Ad/Sponsor (Desktop Only) -->
                <div class="hidden lg:block w-1/4 space-y-4">
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 sticky top-24">
                        <h3 class="font-bold text-gray-800 mb-3 text-center">è´ŠåŠ©å»£å‘Š</h3>
                        <div class="h-40 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 text-sm border-2 border-dashed border-gray-300">å»£å‘Šæ‹›å•†ä¸­</div>
                    </div>
                </div>
            </div>`;
      };

      const renderDiscussion = () => {
        const posts = appState.mockPosts.filter((p) => p.type === "discussion");
        const filters = [
          { id: "all", label: "å…¨éƒ¨" },
          { id: "latest", label: "æœ€æ–°" },
          { id: "liked", label: "æœ‰æŒ‰è®š" },
          { id: "nearby", label: "æ‰¾é™„è¿‘" },
        ];
        const searchUI = getSearchFilterUI("æœå°‹é—œéµå­—ã€æ¨™ç±¤...", filters);

        return `
             <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="bg-orange-50 rounded-2xl p-6 mb-8 flex justify-between items-center border border-orange-100">
                    <div>
                        <h1 class="text-2xl font-bold text-orange-600">è¨è«–å€</h1>
                        <p class="text-orange-400 text-sm">åˆ†äº«ä½ çš„æ—…è¡Œæ•…äº‹èˆ‡ç¶“é©—</p>
                    </div>
                    <button onclick="openModal('posting_choice')" class="bg-orange-500 text-white px-4 py-2 rounded-xl shadow hover:bg-orange-600 transition flex items-center"><i data-lucide="plus" class="w-4 h-4 mr-1"></i> æ–°å¢è©±é¡Œ</button>
                </div>
                ${searchUI}
                <!-- Posts List -->
                ${posts.map(renderArticle).join("")}
             </div>`;
      };

      const renderFindTraveler = () => {
        const posts = appState.mockPosts.filter(
          (p) => p.type === "find_traveler"
        );
        const filters = [
          { id: "all", label: "å…¨éƒ¨" },
          { id: "latest", label: "æœ€æ–°" },
          { id: "liked", label: "æœ‰æŒ‰è®š" },
          { id: "closed", label: "å·²æ‰¾åˆ°/å·²æˆªæ­¢" },
          { id: "nearby", label: "æ‰¾é™„è¿‘" },
        ];
        const searchUI = getSearchFilterUI("æœå°‹ç›®çš„åœ°ã€å‡ºç™¼æ—¥æœŸ...", filters);

        return `
            <div class="max-w-6xl mx-auto">
                 <!-- Header -->
                 <div class="bg-green-50 rounded-2xl p-6 mb-8 flex justify-between items-center border border-green-100">
                    <div>
                        <h1 class="text-2xl font-bold text-green-600">æ‰¾æ—…ä¼´</h1>
                        <p class="text-green-500 text-sm">å°‹æ‰¾å¿—åŒé“åˆçš„æ—…è¡Œå¤¥ä¼´</p>
                    </div>
                    <button onclick="openModal('posting_choice')" class="bg-green-500 text-white px-4 py-2 rounded-xl shadow hover:bg-green-600 transition flex items-center"><i data-lucide="plus" class="w-4 h-4 mr-1"></i> ç™¼èµ·å¾µä¼´</button>
                </div>
                ${searchUI}
                <!-- Grid View for Traveler Posts (2 columns on medium screens and up) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> 
                    ${posts.map(renderTravelerGridCard).join("")}
                </div>
            </div>`;
      };

      const renderFeaturedItinerary = () => {
        const posts = appState.mockPosts.filter(
          (p) => p.type === "featured_itinerary"
        );

        const filters = [
          { id: "all", label: "å…¨éƒ¨" },
          { id: "latest", label: "æœ€æ–°" },
          { id: "popular", label: "ç†±é–€" },
          { id: "top_rated", label: "é«˜è©•åˆ†" },
        ];
        const searchUI = getSearchFilterUI("æœå°‹åœ‹å®¶ã€ä¸»é¡Œ...", filters);

        return `
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="bg-yellow-50 rounded-2xl p-6 mb-8 flex justify-between items-center border border-yellow-100">
                    <div>
                        <h1 class="text-2xl font-bold text-yellow-600">ç²¾é¸è¡Œç¨‹</h1>
                        <p class="text-yellow-500 text-sm">åƒè€ƒé”äººè¡Œç¨‹ï¼Œè¼•é¬†è¦åŠƒæ—…ç¨‹</p>
                    </div>
                    <button onclick="openModal('future_feature')" class="bg-yellow-500 text-white px-4 py-2 rounded-xl shadow hover:bg-yellow-600 transition flex items-center"><i data-lucide="sparkles" class="w-4 h-4 mr-1"></i> è¦åŠƒæ–°è¡Œç¨‹</button>
                </div>
                ${searchUI}
                <!-- Posts List -->
                <div>
                    ${posts.map(renderArticle).join("")}
                </div>
            </div>`;
      };

      // --- My Itinerary Page Components ---

      const renderItineraryItem = (item) => `
            <!-- é»æ“Šå¾Œæ‰“é–‹è©³ç´°è¡Œç¨‹åœ–ç¤ºåŒ–è¦–åœ– -->
            <div onclick="openModal('itinerary_edit', '${item.id}')" class="p-4 rounded-xl border-2 border-gray-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-400 transition shadow-sm mb-4">
                <h4 class="font-bold text-lg text-gray-800">${item.title}</h4>
                <p class="text-sm text-gray-500">${item.startDate || ""} - ${item.endDate || ""}</p>
            </div>
        `;

      const renderDraftItem = (draft) => {
        return `
                <div onclick="openModal('future_feature')" class="p-4 rounded-xl border border-gray-200 mb-4 cursor-pointer hover:bg-yellow-50 transition shadow-sm">
                    <div class="flex items-center space-x-2 mb-1">
                        <!-- Badge for draft type -->
                        <span class="text-xs font-bold text-white px-2 py-0.5 rounded ${draft.type === "discussion" ? "bg-indigo-500" : "bg-green-500"}">${draft.type === "discussion" ? "è¨è«–å€" : "æ‰¾æ—…ä¼´"}</span>
                        <span class="text-xs text-gray-400">å„²å­˜æ–¼: ${draft.savedAt}</span>
                    </div>
                    <h4 class="font-bold text-gray-800 line-clamp-1">${draft.title}</h4>
                    <p class="text-sm text-gray-500 line-clamp-2">${draft.contentPreview}</p>
                </div>
            `;
      };

      const renderMyItinerary = () => {
        const mockItineraries = appState.mockItineraries;
        const mockDrafts = appState.mockDrafts;

        return `
            <div class="max-w-6xl mx-auto p-4">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-6">æˆ‘çš„è¡Œç¨‹</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Itinerary List (Left/2/3 width) -->
                    <div class="lg:col-span-2 bg-white rounded-3xl p-6 shadow-xl border border-gray-100 h-fit">
                        <div class="flex items-center mb-6 border-b pb-4">
                            <i data-lucide="calendar-check" class="w-8 h-8 text-indigo-600 mr-3"></i>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">è¡Œç¨‹åˆ—è¡¨</h2>
                                <p class="text-sm text-gray-500">æŸ¥çœ‹ä¸¦ç®¡ç†ä½ çš„æ—…éŠè¡Œç¨‹</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            ${mockItineraries.map(renderItineraryItem).join("")}
                        </div>
                        
                        <button onclick="openModal('itinerary_edit', null)" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition flex items-center justify-center space-x-2 shadow-lg hover:shadow-xl">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>æ–°å¢è¡Œç¨‹</span>
                        </button>
                    </div>
                    
                    <!-- Drafts Folder (Right/1/3 width) -->
                    <div class="lg:col-span-1 bg-white rounded-3xl p-6 shadow-xl border border-gray-100 h-fit">
                        <div class="flex items-center mb-6 border-b pb-4">
                            <i data-lucide="folder-output" class="w-8 h-8 text-yellow-600 mr-3"></i>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">è‰ç¨¿å¤¾</h2>
                                <p class="text-sm text-gray-500">æŸ¥çœ‹ä½ å„²å­˜çš„è²¼æ–‡è‰ç¨¿</p>
                            </div>
                        </div>
                        
                        <div>
                            ${mockDrafts.map(renderDraftItem).join("")}
                        </div>
                        
                    </div>
                </div>
            </div>
            `;
      };

      // --- Like Functions ---

      function toggleLike(postId) {
        const index = appState.likedPosts.indexOf(postId);
        if (index > -1) {
          // Remove from liked posts
          appState.likedPosts.splice(index, 1);
          // Decrease like count
          const post = appState.mockPosts.find((p) => p.id === postId);
          if (post) post.hearts = Math.max(0, post.hearts - 1);
        } else {
          // Add to liked posts
          appState.likedPosts.push(postId);
          // Increase like count
          const post = appState.mockPosts.find((p) => p.id === postId);
          if (post) post.hearts = (post.hearts || 0) + 1;
        }
        // Re-render to update UI
        renderApp();
        // Re-create icons to update filled state
        lucide.createIcons();
      }

      // --- Favorite Functions ---

      function toggleFavorite(postId) {
        const index = appState.favorites.indexOf(postId);
        if (index > -1) {
          // Remove from favorites
          appState.favorites.splice(index, 1);
        } else {
          // Add to favorites
          appState.favorites.push(postId);
        }
        // Re-render to update UI
        renderApp();
        // Re-create icons to update filled state
        lucide.createIcons();
      }

      function renderFavorites() {
        const favoritePosts = appState.mockPosts.filter((post) =>
          appState.favorites.includes(post.id)
        );

        if (favoritePosts.length === 0) {
          return `
            <div class="max-w-4xl mx-auto">
              <div class="bg-white rounded-2xl p-12 text-center shadow-sm border border-gray-100">
                <i data-lucide="heart" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">é‚„æ²’æœ‰æ”¶è—çš„è²¼æ–‡</h2>
                <p class="text-gray-500 mb-6">é»æ“Šè²¼æ–‡ä¸Šçš„æ„›å¿ƒæˆ–æ”¶è—æ¨™ç±¤ä¾†æ”¶è—ä½ å–œæ­¡çš„å…§å®¹</p>
                <button onclick="navigate('home')" class="px-6 py-2 bg-indigo-600 text-white rounded-full font-semibold hover:bg-indigo-700 transition">
                  å»æ¢ç´¢è²¼æ–‡
                </button>
              </div>
            </div>
          `;
        }

        return `
          <div class="max-w-4xl mx-auto">
            <div class="mb-6">
              <h1 class="text-3xl font-extrabold text-gray-900 mb-2">æˆ‘çš„æ”¶è—</h1>
              <p class="text-gray-500">å…± ${favoritePosts.length} å‰‡æ”¶è—çš„è²¼æ–‡</p>
            </div>
            ${favoritePosts.map(renderArticle).join("")}
          </div>
        `;
      }

      // --- Post Detail Page Functions ---

      function navigateToPost(postId) {
        appState.currentPostId = postId;
        appState.currentPage = "post_detail";
        renderApp();
        window.scrollTo(0, 0);
      }

      function renderPostDetail() {
        const postId = appState.currentPostId;
        const post = appState.mockPosts.find((p) => p.id === postId);
        if (!post) {
          return `<div class="p-10 text-center text-gray-500">æ‰¾ä¸åˆ°æ–‡ç« </div>`;
        }

        const isFavorited = appState.favorites.includes(postId);
        const isLiked = appState.likedPosts.includes(postId);
        const comments = appState.mockComments[postId] || [];
        const sortedComments = sortCommentsList(comments, appState.commentSort);

        const defaultAvatar =
          "https://placehold.co/100x100/A0BFFF/ffffff?text=User";
        const defaultPostImage =
          "https://placehold.co/800x400/94A3B8/ffffff?text=Post+Image";

        return `
          <div class="flex flex-col lg:flex-row gap-6">
            <!-- Main Content -->
            <div class="w-full lg:w-3/4">
            <!-- Back Button -->
            <button onclick="navigate('discussion')" class="mb-4 flex items-center text-gray-600 hover:text-indigo-600 transition">
              <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
              <span>è¿”å›è¨è«–å€</span>
            </button>

            <!-- Article Section -->
            <div class="bg-white rounded-2xl p-6 mb-6 shadow-sm border border-gray-100">
              <!-- Title with Tags -->
              <div class="mb-4">
                <div class="flex gap-2 mb-3">
                  ${post.tags
                    .map(
                      (t) =>
                        `<span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-lg font-semibold">#${t}</span>`
                    )
                    .join("")}
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-4">${post.title}</h1>
              </div>

              <!-- Author Info -->
              <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-100">
                <div class="flex items-center space-x-3">
                  <img src="${post.avatar}" onerror="this.onerror=null;this.src='${defaultAvatar}';" class="w-12 h-12 rounded-full object-cover">
                  <div>
                    <div class="flex items-center space-x-2">
                      <span class="font-bold text-gray-800">${post.author}</span>
                      ${post.spiritAnimal ? `<span class="text-xs font-semibold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">${post.spiritAnimal}</span>` : ""}
                      ${post.isAuthor ? `<span class="text-xs font-semibold text-orange-500 bg-orange-50 px-2 py-0.5 rounded-full">ä½œè€…</span>` : ""}
                    </div>
                    <div class="text-xs text-gray-400">${post.time}</div>
                  </div>
                </div>
                <button class="px-4 py-2 bg-indigo-600 text-white rounded-full text-sm font-semibold hover:bg-indigo-700 transition">
                  è¿½è¹¤
                </button>
              </div>

              <!-- Article Content -->
              <div class="mb-6">
                <p class="text-gray-800 leading-relaxed whitespace-pre-line">${post.content}</p>
              </div>

              <!-- Post Image -->
              ${
                post.image
                  ? `<div class="w-full rounded-xl overflow-hidden mb-6"><img src="${post.image}" onerror="this.onerror=null;this.src='${defaultPostImage}';" class="w-full h-auto object-cover"></div>`
                  : ""
              }

              <!-- Action Bar -->
              <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                <div class="flex items-center space-x-6 text-gray-400">
                  <button onclick="toggleLike(${postId})" class="flex items-center space-x-2 hover:text-red-500 transition ${isLiked ? "text-red-500" : ""}">
                    <i data-lucide="heart" class="w-5 h-5 ${isLiked ? "fill-red-500" : ""}"></i>
                    <span class="text-sm font-semibold">${post.hearts}</span>
                  </button>
                  <button class="flex items-center space-x-2 hover:text-indigo-600 transition">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                    <span class="text-sm font-semibold">${post.comments}</span>
                  </button>
                </div>
                <div class="flex items-center space-x-4">
                  <button onclick="toggleFavorite(${postId})" class="p-2 ${isFavorited ? "bg-red-500 text-white" : "hover:bg-gray-100"} rounded-full transition">
                    <i data-lucide="bookmark" class="w-5 h-5 ${isFavorited ? "fill-white" : "text-gray-400"}"></i>
                  </button>
                  <button class="p-2 hover:bg-gray-100 rounded-full transition">
                    <i data-lucide="share-2" class="w-5 h-5 text-gray-400"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Comments Section -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
              <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ç•™è¨€(${comments.length})</h2>
                
                <!-- Comment Input -->
                <div class="mb-4">
                  <textarea id="comment-input" placeholder="å¯«ä¸‹ä½ çš„ç•™è¨€..." class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none resize-none" rows="3"></textarea>
                  <div class="flex items-center justify-between mt-3">
                    <div class="flex items-center space-x-2">
                      <button class="p-2 hover:bg-gray-100 rounded-full transition" title="ä¸Šå‚³åœ–ç‰‡ã€MP4">
                        <i data-lucide="image" class="w-5 h-5 text-gray-400"></i>
                      </button>
                      <button class="p-2 hover:bg-gray-100 rounded-full transition" title="ä¸Šå‚³ GIF">
                        <i data-lucide="file-image" class="w-5 h-5 text-gray-400"></i>
                      </button>
                      <button class="p-2 hover:bg-gray-100 rounded-full transition" title="æ’å…¥ emoji">
                        <i data-lucide="smile" class="w-5 h-5 text-gray-400"></i>
                      </button>
                    </div>
                    <button onclick="submitComment(${postId})" class="px-6 py-2 bg-indigo-600 text-white rounded-full font-semibold hover:bg-indigo-700 transition">
                      ç™¼è¡¨
                    </button>
                  </div>
                </div>

                <!-- Sort Buttons -->
                <div class="flex items-center space-x-2 mb-4 pb-4 border-b border-gray-100">
                  <button onclick="sortComments('hot', ${postId})" class="px-4 py-1.5 rounded-full text-sm font-semibold transition ${appState.commentSort === "hot" ? "bg-indigo-600 text-white" : "bg-gray-100 text-gray-600 hover:bg-gray-200"}">
                    ç†±é–€
                  </button>
                  <button onclick="sortComments('newest', ${postId})" class="px-4 py-1.5 rounded-full text-sm font-semibold transition ${appState.commentSort === "newest" ? "bg-indigo-600 text-white" : "bg-gray-100 text-gray-600 hover:bg-gray-200"}">
                    ç”±æ–°è‡³èˆŠ
                  </button>
                  <button onclick="sortComments('oldest', ${postId})" class="px-4 py-1.5 rounded-full text-sm font-semibold transition ${appState.commentSort === "oldest" ? "bg-indigo-600 text-white" : "bg-gray-100 text-gray-600 hover:bg-gray-200"}">
                    ç”±èˆŠè‡³æ–°
                  </button>
                </div>

                <!-- Comments List -->
                <div id="comments-list" class="space-y-6">
                  ${renderCommentsList(sortedComments, postId)}
                </div>
              </div>
            </div>
            </div>
            
            <!-- Right Sidebar Ad (Desktop Only) -->
            <div class="hidden lg:block w-1/4 space-y-4">
              <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 sticky top-24">
                <h3 class="font-bold text-gray-800 mb-3 text-center">é‡‘ä¸»çˆ¸çˆ¸ é€²é§å»£å‘Š</h3>
                <div class="h-40 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 text-sm border-2 border-dashed border-gray-300">å»£å‘Šæ‹›å•†ä¸­</div>
              </div>
              <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 sticky top-24">
                <h3 class="font-bold text-gray-800 mb-3 text-center">é‡‘ä¸»åª½åª½ é€²é§å»£å‘Š</h3>
                <div class="h-40 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 text-sm border-2 border-dashed border-gray-300">å»£å‘Šæ‹›å•†ä¸­</div>
              </div>
            </div>
          </div>
        `;
      }

      function renderCommentsList(comments, postId) {
        if (comments.length === 0) {
          return `<div class="text-center text-gray-400 py-8">é‚„æ²’æœ‰ç•™è¨€ï¼Œå¿«ä¾†æ¶é ­é¦™å§ï¼</div>`;
        }

        return comments
          .map((comment) => {
            const repliesHtml = comment.replies
              ? comment.replies
                  .map(
                    (reply) => `
                  <div class="ml-12 mt-4 pl-4 border-l-2 border-gray-200">
                    <div class="flex items-start space-x-3">
                      <img src="${reply.avatar}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0BFFF/ffffff?text=User';" class="w-8 h-8 rounded-full object-cover flex-shrink-0">
                      <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                          <span class="font-bold text-sm text-gray-800">${reply.author}</span>
                          ${reply.spiritAnimal ? `<span class="text-xs font-semibold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">${reply.spiritAnimal}</span>` : ""}
                          <span class="text-xs text-gray-400">${reply.time}</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">${reply.content}</p>
                        <button class="text-xs text-gray-400 hover:text-indigo-600 transition">
                          <i data-lucide="thumbs-up" class="w-3 h-3 inline mr-1"></i>
                          ${reply.likes}
                        </button>
                      </div>
                    </div>
                  </div>
                `
                  )
                  .join("")
              : "";

            return `
              <div class="comment-item">
                <div class="flex items-start space-x-3">
                  <img src="${comment.avatar}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0BFFF/ffffff?text=User';" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                  <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                      <span class="font-bold text-gray-800">${comment.author}</span>
                      ${comment.isAuthor ? `<span class="text-xs font-semibold text-orange-500 bg-orange-50 px-2 py-0.5 rounded-full">ä½œè€…</span>` : ""}
                      <span class="text-xs text-gray-400">${comment.time}</span>
                    </div>
                    <p class="text-gray-700 mb-2">${comment.content}</p>
                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                      <button class="flex items-center space-x-1 hover:text-indigo-600 transition">
                        <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                        <span>${comment.likes}</span>
                      </button>
                      <button onclick="showReplyInput('${comment.id}', ${postId})" class="flex items-center space-x-1 hover:text-indigo-600 transition">
                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                        <span>å›è¦†</span>
                      </button>
                    </div>
                    ${repliesHtml}
                    <div id="reply-input-${comment.id}" class="hidden mt-4 ml-12">
                      <textarea id="reply-text-${comment.id}" placeholder="å›è¦† ${comment.author}..." class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none resize-none text-sm" rows="2"></textarea>
                      <div class="flex justify-end mt-2">
                        <button onclick="cancelReply('${comment.id}')" class="px-4 py-1.5 text-sm text-gray-600 hover:text-gray-800 mr-2">å–æ¶ˆ</button>
                        <button onclick="submitReply('${comment.id}', ${postId})" class="px-4 py-1.5 bg-indigo-600 text-white rounded-full text-sm font-semibold hover:bg-indigo-700 transition">ç™¼è¡¨</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function sortCommentsList(comments, sortType) {
        const sorted = [...comments];
        switch (sortType) {
          case "hot":
            return sorted.sort((a, b) => b.likes - a.likes);
          case "newest":
            return sorted.sort((a, b) => {
              // Simple time-based sorting (in real app, use actual timestamps)
              return a.time.localeCompare(b.time);
            });
          case "oldest":
            return sorted.sort((a, b) => {
              return b.time.localeCompare(a.time);
            });
          default:
            return sorted;
        }
      }

      function sortComments(sortType, postId) {
        appState.commentSort = sortType;
        renderApp();
      }

      function showReplyInput(commentId, postId) {
        const replyInput = document.getElementById(`reply-input-${commentId}`);
        if (replyInput) {
          replyInput.classList.remove("hidden");
          document.getElementById(`reply-text-${commentId}`)?.focus();
        }
      }

      function cancelReply(commentId) {
        const replyInput = document.getElementById(`reply-input-${commentId}`);
        if (replyInput) {
          replyInput.classList.add("hidden");
          document.getElementById(`reply-text-${commentId}`).value = "";
        }
      }

      function submitReply(commentId, postId) {
        const replyText = document
          .getElementById(`reply-text-${commentId}`)
          ?.value.trim();
        if (!replyText) return;

        // In a real app, this would send to backend
        const comments = appState.mockComments[postId] || [];
        const comment = comments.find((c) => c.id === commentId);
        if (comment) {
          const newReply = {
            id: `r${Date.now()}`,
            author: appState.currentUser.name,
            avatar: appState.currentUser.avatar,
            time: "å‰›å‰›",
            content: replyText,
            likes: 0,
          };
          comment.replies = comment.replies || [];
          comment.replies.push(newReply);
          renderApp();
        }
      }

      function submitComment(postId) {
        const commentInput = document.getElementById("comment-input");
        const content = commentInput?.value.trim();
        if (!content) return;

        // In a real app, this would send to backend
        if (!appState.mockComments[postId]) {
          appState.mockComments[postId] = [];
        }

        const newComment = {
          id: `c${Date.now()}`,
          author: appState.currentUser.name,
          avatar: appState.currentUser.avatar,
          time: "å‰›å‰›",
          content: content,
          likes: 0,
          replies: [],
        };

        appState.mockComments[postId].push(newComment);
        commentInput.value = "";
        renderApp();
      }

      // --- Profile Page Functions ---

      function renderProfile() {
        const user = appState.currentUser;
        const userPosts = appState.mockPosts.filter(
          (p) => p.author === user.name
        );
        const favoriteCount = appState.favorites.length;
        const likedCount = appState.likedPosts.length;

        return `
          <div class="max-w-6xl mx-auto">
            <!-- Profile Header -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-3xl p-8 mb-6 text-white relative overflow-hidden">
              <div class="absolute inset-0 bg-black/10"></div>
              <div class="relative z-10">
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6">
                  <!-- Avatar -->
                  <div class="relative">
                    <img src="${user.avatar}" class="w-32 h-32 rounded-full border-4 border-white shadow-xl object-cover">
                    <button class="absolute bottom-0 right-0 p-2 bg-indigo-600 rounded-full border-2 border-white hover:bg-indigo-700 transition">
                      <i data-lucide="camera" class="w-4 h-4 text-white"></i>
                    </button>
                  </div>
                  
                  <!-- User Info -->
                  <div class="flex-1">
                    <h1 class="text-3xl font-bold mb-2">${user.name}</h1>
                    <p class="text-indigo-100 mb-4">æœƒå“¡ç·¨è™Ÿ: #${Math.floor(Math.random() * 10000)}</p>
                    
                    <!-- Stats -->
                    <div class="flex flex-wrap gap-6">
                      <div class="bg-white/20 backdrop-blur rounded-xl px-4 py-2">
                        <div class="text-2xl font-bold">${userPosts.length}</div>
                        <div class="text-sm text-indigo-100">ç™¼æ–‡æ•¸</div>
                      </div>
                      <div class="bg-white/20 backdrop-blur rounded-xl px-4 py-2">
                        <div class="text-2xl font-bold">${favoriteCount}</div>
                        <div class="text-sm text-indigo-100">æ”¶è—</div>
                      </div>
                      <div class="bg-white/20 backdrop-blur rounded-xl px-4 py-2">
                        <div class="text-2xl font-bold">${likedCount}</div>
                        <div class="text-sm text-indigo-100">æŒ‰è®š</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Edit Button -->
                  <button class="px-6 py-2 bg-white text-indigo-600 rounded-full font-semibold hover:bg-indigo-50 transition shadow-lg">
                    <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                    ç·¨è¼¯è³‡æ–™
                  </button>
                </div>
              </div>
            </div>

            <!-- Profile Content Tabs -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 mb-6">
              <div class="border-b border-gray-200">
                <div class="flex space-x-1 p-2">
                  <button onclick="switchProfileTab('posts')" id="profile-tab-posts" class="flex-1 px-4 py-3 text-center font-semibold rounded-lg hover:bg-gray-50 transition profile-tab active bg-indigo-50 text-indigo-600">
                    <i data-lucide="file-text" class="w-5 h-5 inline mr-2"></i>
                    æˆ‘çš„ç™¼æ–‡
                  </button>
                  <button onclick="switchProfileTab('favorites')" id="profile-tab-favorites" class="flex-1 px-4 py-3 text-center font-semibold rounded-lg hover:bg-gray-50 transition profile-tab text-gray-600">
                    <i data-lucide="heart" class="w-5 h-5 inline mr-2"></i>
                    æˆ‘çš„æ”¶è—
                  </button>
                  <button onclick="switchProfileTab('settings')" id="profile-tab-settings" class="flex-1 px-4 py-3 text-center font-semibold rounded-lg hover:bg-gray-50 transition profile-tab text-gray-600">
                    <i data-lucide="settings" class="w-5 h-5 inline mr-2"></i>
                    å¸³è™Ÿè¨­å®š
                  </button>
                </div>
              </div>

              <!-- Tab Content -->
              <div id="profile-content" class="p-6">
                <!-- My Posts Tab -->
                <div id="profile-posts-content" class="profile-content-section">
                  ${
                    userPosts.length > 0
                      ? `<div class="space-y-4">${userPosts.map(renderArticle).join("")}</div>`
                      : `<div class="text-center py-12 text-gray-400">
                        <i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                        <p class="text-lg">é‚„æ²’æœ‰ç™¼æ–‡</p>
                        <p class="text-sm mt-2">å¿«å»åˆ†äº«ä½ çš„æ—…éŠç¶“é©—å§ï¼</p>
                      </div>`
                  }
                </div>

                <!-- My Favorites Tab -->
                <div id="profile-favorites-content" class="profile-content-section hidden">
                  ${
                    favoriteCount > 0
                      ? `<div class="space-y-4">${appState.mockPosts
                          .filter((p) => appState.favorites.includes(p.id))
                          .map(renderArticle)
                          .join("")}</div>`
                      : `<div class="text-center py-12 text-gray-400">
                        <i data-lucide="heart" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                        <p class="text-lg">é‚„æ²’æœ‰æ”¶è—</p>
                        <p class="text-sm mt-2">é»æ“Šè²¼æ–‡ä¸Šçš„æ”¶è—æŒ‰éˆ•ä¾†æ”¶è—ä½ å–œæ­¡çš„å…§å®¹</p>
                      </div>`
                  }
                </div>

                <!-- Settings Tab -->
                <div id="profile-settings-content" class="profile-content-section hidden">
                  <div class="space-y-6">
                    <div class="border-b border-gray-200 pb-6">
                      <h3 class="text-lg font-bold text-gray-800 mb-4">åŸºæœ¬è³‡æ–™</h3>
                      <div class="space-y-4">
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-2">é¡¯ç¤ºåç¨±</label>
                          <input type="text" value="${user.name}" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-2">é›»å­éƒµä»¶</label>
                          <input type="email" value="user@example.com" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-2">å€‹äººç°¡ä»‹</label>
                          <textarea rows="3" placeholder="ä»‹ç´¹ä¸€ä¸‹è‡ªå·±..." class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none resize-none"></textarea>
                        </div>
                      </div>
                    </div>

                    <div class="border-b border-gray-200 pb-6">
                      <h3 class="text-lg font-bold text-gray-800 mb-4">é€šçŸ¥è¨­å®š</h3>
                      <div class="space-y-3">
                        <label class="flex items-center justify-between cursor-pointer">
                          <span class="text-gray-700">æ¥æ”¶æ–°ç•™è¨€é€šçŸ¥</span>
                          <input type="checkbox" checked class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                          <span class="text-gray-700">æ¥æ”¶æŒ‰è®šé€šçŸ¥</span>
                          <input type="checkbox" checked class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                          <span class="text-gray-700">æ¥æ”¶ç³»çµ±å…¬å‘Š</span>
                          <input type="checkbox" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
                        </label>
                      </div>
                    </div>

                    <div>
                      <h3 class="text-lg font-bold text-gray-800 mb-4">å¸³è™Ÿç®¡ç†</h3>
                      <div class="space-y-3">
                        <button class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition">
                          <div class="font-semibold text-gray-800">è®Šæ›´å¯†ç¢¼</div>
                          <div class="text-sm text-gray-500">å®šæœŸæ›´æ–°å¯†ç¢¼ä»¥ä¿è­·å¸³è™Ÿå®‰å…¨</div>
                        </button>
                        <button class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition">
                          <div class="font-semibold text-gray-800">éš±ç§è¨­å®š</div>
                          <div class="text-sm text-gray-500">ç®¡ç†ä½ çš„éš±ç§å’Œè³‡æ–™å¯è¦‹æ€§</div>
                        </button>
                        <button class="w-full text-left px-4 py-3 bg-red-50 hover:bg-red-100 rounded-xl transition text-red-600">
                          <div class="font-semibold">åˆªé™¤å¸³è™Ÿ</div>
                          <div class="text-sm">æ°¸ä¹…åˆªé™¤ä½ çš„å¸³è™Ÿå’Œæ‰€æœ‰è³‡æ–™</div>
                        </button>
                      </div>
                    </div>

                    <div class="pt-4">
                      <button class="w-full px-6 py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
                        å„²å­˜è®Šæ›´
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function switchProfileTab(tab) {
        // Hide all content sections
        document
          .querySelectorAll(".profile-content-section")
          .forEach((section) => {
            section.classList.add("hidden");
          });

        // Remove active class from all tabs
        document.querySelectorAll(".profile-tab").forEach((btn) => {
          btn.classList.remove("active", "bg-indigo-50", "text-indigo-600");
          btn.classList.add("text-gray-600");
        });

        // Show selected content
        const contentSection = document.getElementById(
          `profile-${tab}-content`
        );
        const tabButton = document.getElementById(`profile-tab-${tab}`);

        if (contentSection) {
          contentSection.classList.remove("hidden");
        }

        if (tabButton) {
          tabButton.classList.add("active", "bg-indigo-50", "text-indigo-600");
          tabButton.classList.remove("text-gray-600");
        }
      }

      // Main Render Function
      function renderApp() {
        const main = document.getElementById("main-content");
        if (appState.currentPage === "home") main.innerHTML = renderHome();
        else if (appState.currentPage === "discussion")
          main.innerHTML = renderDiscussion();
        else if (appState.currentPage === "find_traveler")
          main.innerHTML = renderFindTraveler();
        else if (appState.currentPage === "featured_itinerary")
          main.innerHTML = renderFeaturedItinerary();
        // Render My Itinerary page
        else if (appState.currentPage === "my_itinerary")
          main.innerHTML = renderMyItinerary();
        // Render Favorites page
        else if (appState.currentPage === "favorites")
          main.innerHTML = renderFavorites();
        // Render Post Detail page
        else if (appState.currentPage === "post_detail")
          main.innerHTML = renderPostDetail();
        // Render Profile page
        else if (appState.currentPage === "profile")
          main.innerHTML = renderProfile();
        // Default placeholder for other pages
        else
          main.innerHTML = `<div class="p-10 text-center text-gray-500">é é¢é–‹ç™¼ä¸­...</div>`;
        // Initialize Lucide icons after content is loaded
        lucide.createIcons();
      }

      // Init: Run when the document is fully loaded
      document.addEventListener("DOMContentLoaded", () => {
        navigate(appState.currentPage); // Renders the initial page
        // Ensure the correct initial navigation item is highlighted
        const initialNav = document.getElementById(
          `nav-${appState.currentPage}`
        );
        if (initialNav) initialNav.classList.add("active");
        else document.getElementById("nav-home").classList.add("active"); // Default to home
      });
    </script>
  </body>
</html>
